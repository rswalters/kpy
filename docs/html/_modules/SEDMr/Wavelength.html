<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SEDMr.Wavelength &mdash; SEDM Pipeline 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SEDM Pipeline 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for SEDMr.Wavelength</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="kn">as</span> <span class="nn">pf</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">NPK.Fit</span>
<span class="kn">import</span> <span class="nn">NPK.Bar</span> <span class="kn">as</span> <span class="nn">Bar</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">KDTree</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="kn">as</span> <span class="nn">SG</span>

<span class="kn">from</span> <span class="nn">numpy.polynomial.chebyshev</span> <span class="kn">import</span> <span class="n">chebfit</span><span class="p">,</span> <span class="n">chebval</span>

<span class="kn">import</span> <span class="nn">SEDMr.Extraction</span> <span class="kn">as</span> <span class="nn">Extraction</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">NaN</span><span class="p">,</span> <span class="n">Inf</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">isscalar</span><span class="p">,</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">array</span>


<div class="viewcode-block" id="peakdet"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.peakdet">[docs]</a><span class="k">def</span> <span class="nf">peakdet</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converted from MATLAB script at http://billauer.co.il/peakdet.html</span>
<span class="sd">    </span>
<span class="sd">    Returns two arrays</span>
<span class="sd">    </span>
<span class="sd">    function [maxtab, mintab]=peakdet(v, delta, x)</span>
<span class="sd">    %PEAKDET Detect peaks in a vector</span>
<span class="sd">    %        [MAXTAB, MINTAB] = PEAKDET(V, DELTA) finds the local</span>
<span class="sd">    %        maxima and minima (&quot;peaks&quot;) in the vector V.</span>
<span class="sd">    %        MAXTAB and MINTAB consists of two columns. Column 1</span>
<span class="sd">    %        contains indices in V, and column 2 the found values.</span>
<span class="sd">    %      </span>
<span class="sd">    %        With [MAXTAB, MINTAB] = PEAKDET(V, DELTA, X) the indices</span>
<span class="sd">    %        in MAXTAB and MINTAB are replaced with the corresponding</span>
<span class="sd">    %        X-values.</span>
<span class="sd">    %</span>
<span class="sd">    %        A point is considered a maximum peak if it has the maximal</span>
<span class="sd">    %        value, and was preceded (to the left) by a value lower by</span>
<span class="sd">    %        DELTA.</span>
<span class="sd">    </span>
<span class="sd">    % Eli Billauer, 3.4.05 (Explicitly not copyrighted).</span>
<span class="sd">    % This function is released to the public domain; Any use is allowed.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxtab</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mintab</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Input vectors v and x must have same length&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Input argument delta must be a scalar&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Input argument delta must be positive&#39;</span><span class="p">)</span>

    <span class="n">mn</span><span class="p">,</span> <span class="n">mx</span> <span class="o">=</span> <span class="n">Inf</span><span class="p">,</span> <span class="o">-</span><span class="n">Inf</span>
    <span class="n">mnpos</span><span class="p">,</span> <span class="n">mxpos</span> <span class="o">=</span> <span class="n">NaN</span><span class="p">,</span> <span class="n">NaN</span>

    <span class="n">lookformax</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
        <span class="n">this</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">this</span> <span class="o">&gt;</span> <span class="n">mx</span><span class="p">:</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">this</span>
            <span class="n">mxpos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">this</span> <span class="o">&lt;</span> <span class="n">mn</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">this</span>
            <span class="n">mnpos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lookformax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this</span> <span class="o">&lt;</span> <span class="n">mx</span><span class="o">-</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">maxtab</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mxpos</span><span class="p">,</span> <span class="n">mx</span><span class="p">))</span>
                <span class="n">mn</span> <span class="o">=</span> <span class="n">this</span>
                <span class="n">mnpos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">lookformax</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this</span> <span class="o">&gt;</span> <span class="n">mn</span><span class="o">+</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">mintab</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mnpos</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>
                <span class="n">mx</span> <span class="o">=</span> <span class="n">this</span>
                <span class="n">mxpos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">lookformax</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">maxtab</span><span class="p">),</span> <span class="n">array</span><span class="p">(</span><span class="n">mintab</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_catalog"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.read_catalog">[docs]</a><span class="k">def</span> <span class="nf">read_catalog</span><span class="p">(</span><span class="n">catname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a sextractor catalog called catname and return&quot;&quot;&quot;</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;ascii.sextractor&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cat</span></div>


<div class="viewcode-block" id="hg_to_kdtree"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.hg_to_kdtree">[docs]</a><span class="k">def</span> <span class="nf">hg_to_kdtree</span><span class="p">(</span><span class="n">assoc_hg_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert mercury association to a KD Tree&quot;&quot;&quot;</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assoc_hg_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="mf">546.1</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mf">546.1</span><span class="p">])</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;coeff_ys&#39;</span><span class="p">])</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ff</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;seg_cnt&#39;</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="fiducial_wavelength"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fiducial_wavelength">[docs]</a><span class="k">def</span> <span class="nf">fiducial_wavelength</span><span class="p">():</span>
    <span class="k">return</span> <span class="mf">565.3</span></div>


<div class="viewcode-block" id="fiducial_spectrum"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fiducial_spectrum">[docs]</a><span class="k">def</span> <span class="nf">fiducial_spectrum</span><span class="p">(</span><span class="n">lamstart</span><span class="o">=</span><span class="mf">1050.0</span><span class="p">,</span> <span class="n">lamratio</span><span class="o">=</span><span class="mf">239.</span><span class="o">/</span><span class="mf">240.</span><span class="p">,</span> <span class="n">npx</span><span class="o">=</span><span class="mi">265</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a typical SED Machine spectrum, use for interpolating on grid</span>

<span class="sd">    Reference:</span>
<span class="sd">        The equation for the fiducial spectrum looks like::</span>

<span class="sd">                            x</span>
<span class="sd">            1000 x (239/240)</span>

<span class="sd">    Args:</span>
<span class="sd">        lamstart(float): default is 1050 nm</span>
<span class="sd">        lamratio(float): default is 239/240, good for SEDM</span>
<span class="sd">        npx(int): default of 265 yields a spectrum that goes to ~ 350 nm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lamstart</span> <span class="o">*</span> <span class="n">lamratio</span><span class="o">**</span><span class="n">xx</span></div>


<div class="viewcode-block" id="assoc_hg_with_flats_helper"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.assoc_hg_with_flats_helper">[docs]</a><span class="k">def</span> <span class="nf">assoc_hg_with_flats_helper</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">domedat</span><span class="p">,</span> <span class="n">hgcat</span><span class="p">,</span> <span class="n">guess_offset</span><span class="p">,</span> <span class="n">wavetrees</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">n_done</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_done</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">spec_pos</span> <span class="o">=</span> <span class="n">domedat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec_pos</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec_pos</span><span class="p">[</span><span class="s1">&#39;bkg_ok&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">tracefun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">spec_pos</span><span class="p">[</span><span class="s1">&#39;coeff_ys&#39;</span><span class="p">])</span>
    <span class="n">minx</span> <span class="o">=</span> <span class="n">spec_pos</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">to_return</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wavelen</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">wavetrees</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">guess_offset</span><span class="p">[</span><span class="n">wavelen</span><span class="p">]</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">minx</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tracefun</span><span class="p">(</span><span class="n">minx</span><span class="o">+</span><span class="n">offset</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">x_hg</span><span class="p">,</span> <span class="n">y_hg</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">res</span><span class="p">]</span>
                <span class="n">y_trace</span> <span class="o">=</span> <span class="n">tracefun</span><span class="p">(</span><span class="n">x_hg</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_hg</span> <span class="o">-</span> <span class="n">y_trace</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">to_return</span><span class="p">[</span><span class="n">wavelen</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_hg</span>

    <span class="c1"># outstr = &quot;\r%4.4i : %d&quot; % (idx, len(to_return))</span>
    <span class="c1"># print(outstr, end=&quot;&quot;)</span>
    <span class="c1"># sys.stdout.flush()</span>

    <span class="k">return</span> <span class="n">to_return</span></div>


<div class="viewcode-block" id="assoc_hg_with_flats"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.assoc_hg_with_flats">[docs]</a><span class="k">def</span> <span class="nf">assoc_hg_with_flats</span><span class="p">(</span><span class="n">domedat_par</span><span class="p">,</span> <span class="n">hgcat_par</span><span class="p">,</span> <span class="n">guess_offset_par</span><span class="o">=</span><span class="p">{</span><span class="mf">365.0</span><span class="p">:</span> <span class="mi">231</span><span class="p">,</span>
    <span class="mf">404.6</span><span class="p">:</span> <span class="mi">214</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">:</span> <span class="mi">193</span><span class="p">,</span> <span class="mf">546.1</span><span class="p">:</span> <span class="mi">133</span><span class="p">,</span> <span class="mf">578.00</span><span class="p">:</span> <span class="mi">110</span><span class="p">},</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;assoc_Hg&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Given a set of functions defining the ridgeline of dome flats</span>
<span class="sd">    and a list of positions of mercury lamps, provide a crude wavelength</span>
<span class="sd">    solution</span>

<span class="sd">    Args:</span>
<span class="sd">        guess_offset_par: Dictionary of {wavelength in nm: x position} indicating</span>
<span class="sd">            the rough distance from the segment start to the wavelength</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">domedat</span><span class="p">,</span> <span class="n">hgcat</span><span class="p">,</span> <span class="n">guess_offset</span><span class="p">,</span> <span class="n">wavetrees</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">domedat</span> <span class="o">=</span> <span class="n">domedat_par</span>
    <span class="n">hgcat</span> <span class="o">=</span> <span class="n">hgcat_par</span>
    <span class="n">guess_offset</span> <span class="o">=</span> <span class="n">guess_offset_par</span>

    <span class="n">wavetrees</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hgcat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">wavetrees</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Finding Hg lines on dome traces&quot;</span><span class="p">)</span>
    <span class="c1"># print(&quot;SgID   Nlines&quot;)</span>
    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">domedat</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">assoc_hg_with_flats_helper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">domedat</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># print(&quot;&quot;)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">spec_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">domedat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">wave</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">spec_pos</span><span class="p">[</span><span class="n">wave</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">domedat</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">spec_pos</span></div>


<div class="viewcode-block" id="find_hg_spectra"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.find_hg_spectra">[docs]</a><span class="k">def</span> <span class="nf">find_hg_spectra</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">dYlimit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s2">&quot;find_spectra&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Based on line ratios and positions, determine positions of Hg lines</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        lines: line list</span>
<span class="sd">        dYlimit: </span>

<span class="sd">    Results:</span>
<span class="sd">        Writes [return value] to outname in npy format</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">        Returns dictionary of {wavelength nm: [(pixel coords) ...], ...}</span>
<span class="sd">        Each wavelength has a list of pixel coords of different length.</span>
<span class="sd">        The coordinates are diassociated from one and other.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kdt</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">reg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">hg546</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hg578</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hg436</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hg405</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hg365</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Finding Hg lines in each spectrum&quot;</span><span class="p">)</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">CNT</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">CNT</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">point</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">kdt</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="mi">38</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">point</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;FLUX_ISO&#39;</span><span class="p">])</span>
        <span class="n">mean_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

        <span class="k">for</span> <span class="n">resix</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">resX</span><span class="p">,</span> <span class="n">resY</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">resix</span><span class="p">]</span>
            <span class="n">resFlux</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">resix</span><span class="p">][</span><span class="s1">&#39;FLUX_ISO&#39;</span><span class="p">])</span>
            <span class="n">dX</span> <span class="o">=</span> <span class="n">resX</span> <span class="o">-</span> <span class="n">X</span>

            <span class="n">dY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resY</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dY</span> <span class="o">&gt;</span> <span class="n">dYlimit</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">resFlux</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ratio</span> <span class="o">=</span> <span class="n">flux</span><span class="o">/</span><span class="n">resFlux</span>
            <span class="n">bright</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="n">mean_flux</span><span class="p">)</span>
            <span class="n">resbright</span> <span class="o">=</span> <span class="p">(</span><span class="n">resFlux</span> <span class="o">&gt;</span> <span class="n">mean_flux</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">&lt;</span> <span class="n">dX</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bright</span><span class="p">:</span>
                <span class="n">reg</span> <span class="o">+=</span> <span class="s1">&#39;circle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">, 3) # color=red</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
                <span class="n">reg</span> <span class="o">+=</span> <span class="s1">&#39;circle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">, 3) # color=magenta</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">)</span>
                <span class="n">hg546</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
                <span class="n">hg578</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">6.</span> <span class="o">&lt;</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span> <span class="o">&lt;</span> <span class="n">dX</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">18</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resbright</span><span class="p">:</span>
                <span class="n">hg405</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
                <span class="n">hg436</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">))</span>
                <span class="n">reg</span> <span class="o">+=</span> <span class="s1">&#39;circle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">, 3) # color=green</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
                <span class="n">reg</span> <span class="o">+=</span> <span class="s1">&#39;circle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">, 3) # color=yellow</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">20</span> <span class="o">&lt;</span> <span class="n">dX</span> <span class="o">&lt;</span> <span class="mi">38</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bright</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resbright</span><span class="p">):</span>
                <span class="n">hg365</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">))</span>
                <span class="n">reg</span> <span class="o">+=</span> <span class="s1">&#39;circle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">, 3) # color=blue</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resX</span><span class="p">,</span> <span class="n">resY</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.reg&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="mf">365.0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg365</span><span class="p">),</span>
            <span class="mf">404.6</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg405</span><span class="p">),</span>
            <span class="mf">435.8</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg436</span><span class="p">),</span>
            <span class="mf">546.1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg546</span><span class="p">),</span>
            <span class="mf">578.00</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg578</span><span class="p">)}]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="fractional_sum"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fractional_sum">[docs]</a><span class="k">def</span> <span class="nf">fractional_sum</span><span class="p">(</span><span class="n">FS_Y</span><span class="p">,</span> <span class="n">FS_EW</span><span class="p">,</span> <span class="n">FS_dat</span><span class="p">,</span> <span class="n">FS_Yx1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns sum of FS_dat via a partial-pixel method.</span>

<span class="sd">    Args:</span>
<span class="sd">        FS_Y(float): location of trace in vertical direciton</span>
<span class="sd">        FS_EW(float): Width of trace around FS_Y</span>
<span class="sd">        FS_dat(float vector): Data to sum</span>
<span class="sd">        FS_Yx1(float): Start location of data</span>

<span class="sd">    Returns:</span>
<span class="sd">        Float containing the sum of data in FS_Y while taking partial</span>
<span class="sd">            pixels into account.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FS_dat</span><span class="p">)</span>
    <span class="n">YB1</span> <span class="o">=</span> <span class="n">FS_Y</span> <span class="o">-</span> <span class="n">FS_EW</span>
    <span class="n">YB2</span> <span class="o">=</span> <span class="n">FS_Y</span> <span class="o">+</span> <span class="n">FS_EW</span>
    <span class="n">FSsum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="n">Yp1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">FS_Yx1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">Yp2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">FS_Yx1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">frac</span><span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># fully contained?</span>
        <span class="k">if</span> <span class="n">Yp1</span> <span class="o">&gt;</span> <span class="n">YB1</span> <span class="ow">and</span> <span class="n">Yp2</span> <span class="o">&lt;</span> <span class="n">YB2</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># pixel surrounds left boundary</span>
        <span class="k">elif</span> <span class="n">Yp1</span> <span class="o">&lt;</span> <span class="n">YB1</span> <span class="o">&lt;</span> <span class="n">Yp2</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">Yp2</span> <span class="o">-</span> <span class="n">YB1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Yp2</span> <span class="o">-</span> <span class="n">Yp1</span><span class="p">)</span>
        <span class="c1"># pixel surrounds right boundary</span>
        <span class="k">elif</span> <span class="n">Yp2</span> <span class="o">&gt;</span> <span class="n">YB2</span> <span class="o">&gt;</span> <span class="n">Yp1</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">YB2</span> <span class="o">-</span> <span class="n">Yp1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Yp2</span> <span class="o">-</span> <span class="n">Yp1</span><span class="p">)</span>

        <span class="n">FSsum</span> <span class="o">+=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">FS_dat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">FSsum</span></div>


<div class="viewcode-block" id="make_profile"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.make_profile">[docs]</a><span class="k">def</span> <span class="nf">make_profile</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a gaussian profile with the same dimensions as the slice &quot;&quot;&quot;</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">profile</span><span class="o">*</span><span class="n">profile</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma2</span><span class="p">))</span>
    <span class="n">profile</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span></div>


<div class="viewcode-block" id="wavelength_extract_helper"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.wavelength_extract_helper">[docs]</a><span class="k">def</span> <span class="nf">wavelength_extract_helper</span><span class="p">(</span><span class="n">SS</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">dat</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> <span class="n">wavecalib</span><span class="p">,</span> <span class="n">HDUlist</span><span class="p">,</span> <span class="n">extract_width</span><span class="p">,</span> <span class="n">flt_corrs</span><span class="p">,</span> \
        <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">n_done</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_done</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">ix</span><span class="p">,</span> <span class="n">flexure_x_corr_nm</span><span class="p">,</span> <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="n">SS</span>

    <span class="n">ss</span> <span class="o">=</span> <span class="n">wavecalib</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Extraction</span><span class="o">.</span><span class="n">Extraction</span><span class="p">(</span><span class="n">seg_id</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">seg_id</span><span class="p">,</span> <span class="n">ok</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                     <span class="n">trace_sigma</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">trace_sigma</span><span class="p">,</span>
                                     <span class="n">Q_ix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Q_ix</span><span class="p">,</span> <span class="n">R_ix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">R_ix</span><span class="p">,</span>
                                     <span class="n">X_as</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">X_as</span><span class="p">,</span> <span class="n">Y_as</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Y_as</span><span class="p">,</span>
                                     <span class="n">X_pix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">X_pix</span><span class="p">,</span><span class="n">Y_pix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Y_pix</span><span class="p">)</span>

    <span class="n">minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">minx</span> <span class="o">+</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">2047</span><span class="p">))</span>
    <span class="n">yfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">poly</span><span class="p">)</span>

    <span class="n">xpos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">resw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">resw</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">resf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">resf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">reswf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">reswf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">trace_sigma</span> <span class="o">*</span> <span class="n">ss</span><span class="o">.</span><span class="n">trace_sigma</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigma2</span><span class="p">):</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="mf">4.</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">)):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">yfun</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="o">&gt;</span> <span class="mi">2046</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="mi">2046</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Extract width requires asymmetry in the slice</span>
        <span class="c1"># slice[-2:3] will return elements -2 to +2 around 0</span>
        <span class="c1"># e.g. len(slice[-2:3]) == 5</span>
        <span class="n">Ys</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">flexure_y_corr_pix</span><span class="o">-</span><span class="n">extract_width</span><span class="p">))),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">flexure_y_corr_pix</span><span class="o">+</span><span class="n">extract_width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2047</span><span class="p">))))</span>

        <span class="c1"># Expanded slice for fractional pixels</span>
        <span class="n">Yx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">flexure_y_corr_pix</span><span class="o">-</span><span class="n">extract_width</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">flexure_y_corr_pix</span><span class="o">+</span><span class="n">extract_width</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2047</span><span class="p">))))</span>

        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">Ys</span><span class="p">,</span> <span class="n">X</span><span class="p">])</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="n">make_profile</span><span class="p">(</span><span class="n">Ys</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2</span><span class="p">)</span>
        <span class="n">resw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">Ys</span><span class="p">,</span> <span class="n">X</span><span class="p">]</span><span class="o">*</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">resf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractional_sum</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">extract_width</span><span class="p">,</span> <span class="n">dat</span><span class="p">[</span><span class="n">Yx</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">Yx</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="n">make_profile</span><span class="p">(</span><span class="n">Yx</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2</span><span class="p">)</span>
        <span class="n">reswf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractional_sum</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">extract_width</span><span class="p">,</span> <span class="n">dat</span><span class="p">[</span><span class="n">Yx</span><span class="p">,</span> <span class="n">X</span><span class="p">]</span><span class="o">*</span><span class="n">profile</span><span class="p">,</span>
                                  <span class="n">Yx</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">)</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">flt_corrs</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">get_correction</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">Extraction</span><span class="o">.</span><span class="n">Extraction</span><span class="p">(</span><span class="nb">xrange</span><span class="o">=</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span> <span class="n">yrange</span><span class="o">=</span><span class="p">(</span><span class="n">yfun</span><span class="p">(</span><span class="n">xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                               <span class="n">yfun</span><span class="p">(</span><span class="n">xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                               <span class="n">poly</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">poly</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                               <span class="n">specw</span><span class="o">=</span><span class="n">resw</span><span class="o">/</span><span class="n">fc</span><span class="p">,</span>
                               <span class="n">specf</span><span class="o">=</span><span class="n">resf</span><span class="o">/</span><span class="n">fc</span><span class="p">,</span>
                               <span class="n">specwf</span><span class="o">=</span><span class="n">reswf</span><span class="o">/</span><span class="n">fc</span><span class="p">,</span>
                               <span class="n">seg_id</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">seg_id</span><span class="p">,</span> <span class="n">exptime</span><span class="o">=</span><span class="n">exptime</span><span class="p">,</span> <span class="n">ok</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">trace_sigma</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">trace_sigma</span><span class="p">,</span> <span class="n">Q_ix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Q_ix</span><span class="p">,</span>
                               <span class="n">R_ix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">R_ix</span><span class="p">,</span> <span class="n">X_as</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">X_as</span><span class="p">,</span> <span class="n">Y_as</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Y_as</span><span class="p">,</span>
                               <span class="n">X_pix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">X_pix</span><span class="p">,</span> <span class="n">Y_pix</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">Y_pix</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;lamcoeff&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">__dict__</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamcoeff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">flexure_x_corr_nm</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamrms</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamrms</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamnrms</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamnrms</span>

    <span class="k">if</span> <span class="s1">&#39;mdn_coeff&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">__dict__</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">mdn_coeff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">mdn_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">flexure_x_corr_nm</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamrms</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamrms</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">lamnrms</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">lamnrms</span>

    <span class="c1"># if ex.lamrms is not None:</span>
        <span class="c1"># outstr = &quot;\r%4i  %6.4f nm  %6.4f    &quot; % (ex.seg_id, ex.lamrms, fc)</span>
        <span class="c1"># print(outstr, end=&quot;&quot;)</span>
        <span class="c1"># sys.stdout.flush()</span>

    <span class="k">return</span> <span class="n">ex</span></div>


<div class="viewcode-block" id="wavelength_extract"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.wavelength_extract">[docs]</a><span class="k">def</span> <span class="nf">wavelength_extract</span><span class="p">(</span><span class="n">HDUlist_par</span><span class="p">,</span> <span class="n">wavecalib_par</span><span class="p">,</span>
                       <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;extracted_spectra.npy&#39;</span><span class="p">,</span>
                       <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">extract_width_par</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">inname</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">flat_corrections</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">dat</span><span class="p">,</span> <span class="n">exptime</span><span class="p">,</span> <span class="n">wavecalib</span><span class="p">,</span> <span class="n">HDUlist</span><span class="p">,</span> <span class="n">extract_width</span><span class="p">,</span> <span class="n">flt_corrs</span><span class="p">,</span> \
           <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">extract_width</span> <span class="o">=</span> <span class="n">extract_width_par</span>

    <span class="n">HDUlist</span> <span class="o">=</span> <span class="n">HDUlist_par</span>
    <span class="n">wavecalib</span> <span class="o">=</span> <span class="n">wavecalib_par</span>
    <span class="n">flt_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flat_corrections</span><span class="p">)</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">HDUlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">HDUlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Applying </span><span class="si">%f</span><span class="s2"> nm / </span><span class="si">%f</span><span class="s2"> px offset&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                             <span class="n">flexure_y_corr_pix</span><span class="p">))</span>
    <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">flexure_y_corr_pix</span><span class="p">)</span>

    <span class="n">SSs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ix</span><span class="p">,</span> <span class="n">flexure_x_corr_nm</span><span class="p">,</span> <span class="n">flexure_y_corr_pix</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavecalib</span><span class="p">))]</span>

    <span class="c1"># print(&quot;SgID  LamRMS     Flat&quot;)</span>
    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SSs</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">extractions</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wavelength_extract_helper</span><span class="p">,</span> <span class="n">SSs</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># print(&quot;&quot;)</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inname&quot;</span><span class="p">:</span> <span class="n">inname</span><span class="p">,</span> <span class="s2">&quot;extract_width&quot;</span><span class="p">:</span> <span class="n">extract_width_par</span><span class="p">,</span>
            <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">(),</span>
            <span class="s2">&quot;flexure_x_corr_nm&quot;</span><span class="p">:</span> <span class="n">flexure_x_corr_nm</span><span class="p">,</span>
            <span class="s2">&quot;flexure_y_corr_pix&quot;</span><span class="p">:</span> <span class="n">flexure_y_corr_pix</span><span class="p">,</span>
            <span class="s2">&quot;outname&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">extractions</span><span class="p">,</span> <span class="n">meta</span><span class="p">]</span></div>


<div class="viewcode-block" id="extract_helper"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.extract_helper">[docs]</a><span class="k">def</span> <span class="nf">extract_helper</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; TODO: MERGE WITH wavelength_extract_helper.</span>
<span class="sd">    Functionallity is repeated.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">dat</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">n_done</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_done</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;bkg_ok&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">Extraction</span><span class="o">.</span><span class="n">Extraction</span><span class="p">(</span><span class="n">seg_id</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;seg_cnt&#39;</span><span class="p">],</span>
                                     <span class="n">trace_sigma</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;trace_sigma&#39;</span><span class="p">],</span>
                                     <span class="n">bkg_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">minx</span> <span class="o">+</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">2047</span><span class="p">))</span>
    <span class="n">yfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;coeff_ys&#39;</span><span class="p">])</span>

    <span class="n">xpos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">resw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">resw</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">resf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">resf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">reswf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
    <span class="n">reswf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;trace_sigma&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;trace_sigma&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigma2</span><span class="p">):</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">extract_width</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xpos</span><span class="p">)):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">yfun</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="o">&gt;</span> <span class="mi">2046</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="mi">2046</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">Ys</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2047</span><span class="p">)))</span>
        <span class="c1"># Expanded slice for fractional pixels</span>
        <span class="n">Yx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">-</span><span class="n">extract_width</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">extract_width</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2047</span><span class="p">))))</span>

        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">Ys</span><span class="p">,</span> <span class="n">X</span><span class="p">])</span>
        <span class="c1"># BUG: calling resw what should be resf, this is a cheap workaround</span>
        <span class="c1"># for now.</span>
        <span class="n">resw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fractional_sum</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">extract_width</span><span class="p">,</span> <span class="n">dat</span><span class="p">[</span><span class="n">Yx</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">Yx</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

    <span class="n">hg_lines</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wave</span><span class="p">,</span> <span class="n">pix</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">hg_lines</span><span class="p">[</span><span class="n">wave</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-</span><span class="n">minx</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">Extraction</span><span class="o">.</span><span class="n">Extraction</span><span class="p">(</span><span class="nb">xrange</span><span class="o">=</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span>
                                 <span class="n">yrange</span><span class="o">=</span><span class="p">(</span><span class="n">yfun</span><span class="p">(</span><span class="n">xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">yfun</span><span class="p">(</span><span class="n">xpos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                                 <span class="n">poly</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;coeff_ys&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">specw</span><span class="o">=</span><span class="n">resw</span><span class="p">,</span>
                                 <span class="n">hg_lines</span><span class="o">=</span><span class="n">hg_lines</span><span class="p">,</span> <span class="n">seg_id</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;seg_cnt&#39;</span><span class="p">],</span>
                                 <span class="n">bkg_ok</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;bkg_ok&#39;</span><span class="p">],</span> <span class="n">ok</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">],</span>
                                 <span class="n">trace_sigma</span><span class="o">=</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;trace_sigma&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="extract"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.extract">[docs]</a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">HDUlist</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;raw_extractions&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">dat</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">HDUlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assoc_hg_spec</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">extractions</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">extract_helper</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">extractions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extractions</span></div>


<div class="viewcode-block" id="median_fine_grid"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.median_fine_grid">[docs]</a><span class="k">def</span> <span class="nf">median_fine_grid</span><span class="p">(</span><span class="n">fine</span><span class="p">,</span> <span class="n">doPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Using the 7 nearest neighbors, median the wavelength solution.</span>
<span class="sd">    Refit the wavelength solution to this median wavelength.</span>

<span class="sd">    Input:</span>
<span class="sd">        fine: Dictionary that contains the fine wavelength solution</span>

<span class="sd">    Returns:</span>
<span class="sd">        fine.mdn_coeff contains updated chebyshev polynomial coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gix</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fine</span><span class="p">):</span>
        <span class="c1"># Create X, Y, and ID vector.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">))</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">yrange</span><span class="p">))</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">seg_id</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">!=</span> <span class="n">dat</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>  <span class="c1"># Correct NaNs</span>
    <span class="n">KD</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fine</span><span class="p">))</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fine</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fine</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">seg_id</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">seg_id</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">seg_id</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">nearest_ixs</span> <span class="o">=</span> <span class="n">KD</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="n">lls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nearest</span> <span class="ow">in</span> <span class="n">nearest_ixs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">nearest</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">lamnrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">lamnrms</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">265</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xx</span><span class="o">+</span><span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fine</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">lls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
            <span class="n">num_in</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_in</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">lamcoeff</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lls</span> <span class="o">-</span> <span class="n">new_lls</span><span class="p">)</span> <span class="o">/</span> <span class="n">new_lls</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="o">/</span><span class="n">stds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">bad</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">lls</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lls</span> <span class="o">-</span> <span class="n">new_lls</span><span class="p">)</span> <span class="o">/</span> <span class="n">new_lls</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="o">/</span><span class="n">stds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">bad</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">lls</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lls</span><span class="p">))</span><span class="o">+</span><span class="n">spec</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">new_lls</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">doPlot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1">#plm = pl.get_current_fig_manager()</span>
        <span class="c1">#plm.window.wm_geometry(&quot;+670+0&quot;)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mi">550</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wave[nm]&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spec Irr [ph/10 m/nm]&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;mdn_coeff&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mi">550</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wave[nm]&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Spec Irr [ph/10 m/nm]&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;lamcoeff&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">fine</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1900</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">yrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">yrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1900</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g</span><span class="o">.</span><span class="n">mdn_coeff</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fine</span></div>


<div class="viewcode-block" id="median_rough_grid"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.median_rough_grid">[docs]</a><span class="k">def</span> <span class="nf">median_rough_grid</span><span class="p">(</span><span class="n">gridded</span><span class="p">,</span> <span class="n">Hg_E</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;median_rough_wavelength.npy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Using the 7 nearest neighbors, median the wavelength soln coeffs</span>

<span class="sd">    this code is of very little use</span>

<span class="sd">        median_rough grid was used to test the idea</span>
<span class="sd">        as of 20 jan 2015, the algorithm tested by this code does not</span>
<span class="sd">        work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gix</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gridded</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="mf">546.1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">hg_lines</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">hg_lines</span><span class="p">[</span><span class="mf">546.1</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">yrange</span><span class="p">))</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">seg_id</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">KD</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">nearest_ixs</span> <span class="o">=</span> <span class="n">KD</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="c1"># print(dist, nearest_ixs)</span>

        <span class="n">lls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nix</span><span class="p">,</span> <span class="n">nearest</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">nearest_ixs</span><span class="p">]):</span>
            <span class="c1"># print(nearest, dist[nix])</span>
            <span class="c1"># if dist[nix] &gt; 100: continue</span>
            <span class="k">if</span> <span class="n">gridded</span><span class="p">[</span><span class="n">nearest</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">265</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">gridded</span><span class="p">[</span><span class="n">nearest</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hgcoef</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">lls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
            <span class="n">num_in</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_in</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="n">lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># new_lls_std = np.nanstd(lls, 0)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lls</span> <span class="o">-</span> <span class="n">new_lls</span><span class="p">)</span> <span class="o">/</span> <span class="n">new_lls</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">05</span>
        <span class="n">lls</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lls</span> <span class="o">-</span> <span class="n">new_lls</span><span class="p">)</span> <span class="o">/</span> <span class="n">new_lls</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">05</span>
        <span class="n">lls</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">new_lls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">gridded</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">mdn_hgcoef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lls</span><span class="p">)),</span> <span class="n">new_lls</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mi">1100</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gridded</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;mdn_hgcoef&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">mdn_hgcoef</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">pdb</span>
    <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></div>


<div class="viewcode-block" id="scale_on_547"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.scale_on_547">[docs]</a><span class="k">def</span> <span class="nf">scale_on_547</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">specw</span><span class="p">),</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ix_547</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">hgcoef</span><span class="p">)</span> <span class="o">-</span> <span class="mf">547.0</span><span class="p">))</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span> <span class="o">-</span> <span class="n">ix</span><span class="p">[</span><span class="n">ix_547</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">scale</span></div>


<div class="viewcode-block" id="stretch_fit_helper"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.stretch_fit_helper">[docs]</a><span class="k">def</span> <span class="nf">stretch_fit_helper</span><span class="p">(</span><span class="n">specno</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper for Multiprocessing Pool&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">pix_coeffs</span><span class="p">,</span> <span class="n">fid_ix</span><span class="p">,</span> <span class="n">fs1</span><span class="p">,</span> <span class="n">fs2</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">squares</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">funs</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">n_done</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_done</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">specno</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">xcs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">squares</span><span class="p">)))</span>
    <span class="n">xcs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">squares</span><span class="p">)))</span>

    <span class="n">s1f</span><span class="p">,</span> <span class="n">s2f</span> <span class="o">=</span> <span class="n">funs</span><span class="p">[</span><span class="n">specno</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slopes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
            <span class="c1"># Step 4</span>
            <span class="n">ns1</span> <span class="o">=</span> <span class="n">s1f</span><span class="p">(</span><span class="n">fid_ix</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">fid_ix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">square</span><span class="p">)</span>
            <span class="n">ns2</span> <span class="o">=</span> <span class="n">s2f</span><span class="p">(</span><span class="n">fid_ix</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">fid_ix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">square</span><span class="p">)</span>
            <span class="n">xcs1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fs1</span><span class="o">*</span><span class="n">fs1</span><span class="o">*</span><span class="n">ns1</span><span class="o">*</span><span class="n">ns1</span><span class="p">)</span>
            <span class="n">xcs2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fs2</span><span class="o">*</span><span class="n">fs2</span><span class="o">*</span><span class="n">ns2</span><span class="o">*</span><span class="n">ns2</span><span class="p">)</span>

    <span class="n">slope1</span><span class="p">,</span> <span class="n">square1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">xcs1</span><span class="p">),</span> <span class="n">xcs1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">slope2</span><span class="p">,</span> <span class="n">square2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">xcs2</span><span class="p">),</span> <span class="n">xcs2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">ix1</span> <span class="o">=</span> <span class="n">fid_ix</span> <span class="o">*</span> <span class="n">slopes</span><span class="p">[</span><span class="n">slope1</span><span class="p">]</span> <span class="o">+</span> <span class="n">fid_ix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">squares</span><span class="p">[</span><span class="n">square1</span><span class="p">]</span>
    <span class="n">ix2</span> <span class="o">=</span> <span class="n">fid_ix</span> <span class="o">*</span> <span class="n">slopes</span><span class="p">[</span><span class="n">slope2</span><span class="p">]</span> <span class="o">+</span> <span class="n">fid_ix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">squares</span><span class="p">[</span><span class="n">square2</span><span class="p">]</span>

    <span class="n">tofit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ix1</span><span class="p">))</span>
    <span class="n">tofit</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">150</span><span class="p">]</span>
    <span class="n">tofit</span><span class="p">[</span><span class="mi">150</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">[</span><span class="mi">150</span><span class="p">:]</span>

    <span class="c1"># Step 5</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">fid_ix</span><span class="p">,</span> <span class="n">tofit</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcs1</span><span class="p">[</span><span class="n">slope1</span><span class="p">,</span> <span class="n">square1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xcs2</span><span class="p">[</span><span class="n">slope2</span><span class="p">,</span> <span class="n">square2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fs1</span><span class="p">)</span>

    <span class="c1"># outstr = &quot;\r%4.0i = %1.3e : %1.3f %+1.2e, %1.3f %+1.2e&quot; % (specno, xc,slopes[slope1], squares[square1], slopes[slope2], squares[square2])</span>
    <span class="c1"># print(outstr,)</span>
    <span class="c1"># sys.stdout.flush()</span>

    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fid_ix</span><span class="p">,</span> <span class="n">s1f</span><span class="p">(</span><span class="n">tofit</span><span class="p">)</span><span class="o">+</span><span class="n">s2f</span><span class="p">(</span><span class="n">tofit</span><span class="p">))</span>

        <span class="kn">import</span> <span class="nn">pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fc</span><span class="p">,</span> <span class="n">xc</span></div>


<div class="viewcode-block" id="get_stretched"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.get_stretched">[docs]</a><span class="k">def</span> <span class="nf">get_stretched</span><span class="p">(</span><span class="n">fid_ix</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">spec1</span><span class="p">,</span> <span class="n">spec2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reinterpolate spec1 and spec2 onto the fiducial index set by</span>
<span class="sd">    stretching and scaling the spectra</span>

<span class="sd">    This is used after a call that looks something like:</span>
<span class="sd">        ll = np.load(&quot;Hg_ext.npy&quot;)</span>
<span class="sd">        lx = np.load(&quot;Xe_ext.npy&quot;)</span>
<span class="sd">        gg = rough_grid(ll)</span>
<span class="sd">        coeffs, fix = stretch_set(gg, lx)</span>

<span class="sd">        s1, s2 = get_stretched(fix, coeffs[5], ll[5], lx[5])</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        s1, s2 [float(len(fid_ix))]: Spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">newix</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">fid_ix</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">scale_on_547</span><span class="p">(</span><span class="n">spec1</span><span class="p">)</span>
    <span class="n">sf1</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">spec1</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">sf2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sf2</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">spec2</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">s1</span> <span class="o">=</span> <span class="n">sf1</span><span class="p">(</span><span class="n">newix</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">sf2</span><span class="p">(</span><span class="n">newix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s1</span><span class="o">/</span><span class="n">s1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="n">spec1</span><span class="o">.</span><span class="n">specw</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">s2</span><span class="o">/</span><span class="n">s2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="n">spec2</span><span class="o">.</span><span class="n">specw</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>


<div class="viewcode-block" id="stretch_set"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.stretch_set">[docs]</a><span class="k">def</span> <span class="nf">stretch_set</span><span class="p">(</span><span class="n">Hg_set</span><span class="p">,</span> <span class="n">Xe_set</span><span class="p">,</span> <span class="n">mscales</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Shift and stretch spectra so they have the same pixel index </span>

<span class="sd">    Steps:</span>
<span class="sd">    1. Shift spectra without interpolation onto a common pixel grid with</span>
<span class="sd">     index 0 being a prominent Hg line.</span>
<span class="sd">    2. Create a set of interpolating functions for each of the spectra</span>
<span class="sd">     in the set. These functions are called as flux(pixel).</span>
<span class="sd">    3. Brute force search for the best stretch and 2nd-order polynomial</span>
<span class="sd">     coeff for each spectrum in the set, compared to the fiducial spectrum.</span>
<span class="sd">    4. Brute force will measure the above for the xenon and mercury spectra</span>
<span class="sd">     indepdentnly.</span>
<span class="sd">    5. Then we stitch together a master pixel shift based on a chebyshev fit</span>
<span class="sd">     of the xenon and mercury spectra. The chebyshev fit creates a function</span>
<span class="sd">     such that f(pixel) --&gt; pixel. On this new grid, all spectra are close</span>
<span class="sd">     to the same.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Global is for interprocess comms</span>
    <span class="k">global</span> <span class="n">pix_coeffs</span><span class="p">,</span> <span class="n">fid_ix</span><span class="p">,</span> <span class="n">fs1</span><span class="p">,</span> <span class="n">fs2</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="n">squares</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">funs</span><span class="p">,</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hg_set</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xe_set</span><span class="p">))</span>

    <span class="c1"># Step 1</span>
    <span class="n">gridded_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Hg_set</span><span class="p">):</span>
        <span class="n">gridded_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="n">Xe_set</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hg</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">xe</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">hg</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xe</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span>
        <span class="n">ix_547</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">hg</span><span class="o">.</span><span class="n">hgcoef</span><span class="p">)</span> <span class="o">-</span> <span class="mf">547.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ix_547</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">ix_547</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span> <span class="o">-</span> <span class="n">ix_547</span>

        <span class="n">gridded_set</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">hg</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">xe</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

    <span class="n">fiducial</span> <span class="o">=</span> <span class="n">gridded_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">fiducial</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fiducial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">265</span><span class="p">:</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">gridded_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fiducial</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fiducial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">265</span><span class="p">:</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">gridded_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fiducial</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fiducial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">265</span><span class="p">:</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">gridded_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fiducial</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fiducial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">265</span><span class="p">:</span>
        <span class="n">fiducial</span> <span class="o">=</span> <span class="n">gridded_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fiducial</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No good fiducial&quot;</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Number of extractions: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">))</span>

    <span class="c1"># Step 2</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">interp_functions</span><span class="p">():</span>
        <span class="n">funs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gridded_set</span><span class="p">):</span>
            <span class="n">funs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ix</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">element</span>
            <span class="n">s1f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">s2f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">funs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1f</span><span class="p">,</span> <span class="n">s2f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">funs</span>

    <span class="n">funs</span> <span class="o">=</span> <span class="n">interp_functions</span><span class="p">()</span>

    <span class="n">pix_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fid_ix</span><span class="p">,</span> <span class="n">fs1</span><span class="p">,</span> <span class="n">fs2</span> <span class="o">=</span> <span class="n">fiducial</span>
    <span class="c1"># Note 0.001 over 250 pixels is about a quarter pixel</span>
    <span class="c1"># max of 0.5e-3 over 150**2 is a handful of pixels.</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="o">/.</span><span class="mi">95</span><span class="p">,</span> <span class="o">.</span><span class="mo">001</span><span class="p">)</span>
    <span class="n">squares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

    <span class="n">specs</span> <span class="o">=</span> <span class="n">gridded_set</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">stretch_fit_helper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">pix_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pix_coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">xcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pix_coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pix_coeffs</span><span class="p">,</span> <span class="n">fiducial</span><span class="p">,</span> <span class="n">xcs</span></div>


<span class="c1"># TODO -- REFIT Wavelengths given a good guess</span>

<span class="c1"># Linelist for calib lamps (currently not using He)</span>
<span class="n">linelist</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;He&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">587.5</span><span class="p">,</span> <span class="mf">667.8</span><span class="p">,</span> <span class="mf">706.5</span><span class="p">],</span>
    <span class="s2">&quot;Cd&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">467.8</span><span class="p">,</span> <span class="mf">479.9</span><span class="p">,</span> <span class="mf">508.5</span><span class="p">],</span>
    <span class="s2">&quot;Hg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">578</span><span class="p">,</span> <span class="mf">546.1</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">,</span> <span class="mf">404.6</span><span class="p">,</span> <span class="mi">365</span><span class="p">],</span>
    <span class="s2">&quot;Xe&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">764</span><span class="p">,</span> <span class="mi">828</span><span class="p">]</span>
<span class="p">}</span>


<div class="viewcode-block" id="snap_solution_into_place"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.snap_solution_into_place">[docs]</a><span class="k">def</span> <span class="nf">snap_solution_into_place</span><span class="p">(</span><span class="n">PARS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return new Chebyshev coefficients for best fit wavelength solution &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="n">n_done</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_done</span> <span class="o">%</span> <span class="n">update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">PARS</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">ixs</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">lamp_spec</span> <span class="o">=</span> <span class="n">PARS</span>

    <span class="c1"># Use 5-parameter Gaussian to fit line peaks</span>
    <span class="n">fitfun</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">gaussian5</span>
    <span class="n">resfun</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_residuals</span><span class="p">(</span><span class="n">fitfun</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fitlinelist</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fit a line list using input coefficients as a first guess at</span>
<span class="sd">        dispersion function. </span>
<span class="sd">        </span>
<span class="sd">        INPUTS:</span>
<span class="sd">        </span>
<span class="sd">        cc - Chebyshev coeffs to use</span>
<span class="sd">        </span>
<span class="sd">        KEYWORDS:</span>
<span class="sd">        </span>
<span class="sd">        printout - set to True to get running status on line-fitting</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initial solution</span>
        <span class="n">lams</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>

        <span class="c1"># array for results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over lamps: Hg, Xe, Cd, He?</span>
        <span class="k">for</span> <span class="n">lampname</span><span class="p">,</span> <span class="n">lampspec</span> <span class="ow">in</span> <span class="n">lamp_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Loop over lines for the given lamp</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">linelist</span><span class="p">[</span><span class="n">lampname</span><span class="p">]:</span>

                <span class="c1"># Find the appropriate line</span>
                <span class="n">lix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">-</span><span class="n">lams</span><span class="p">))</span>

                <span class="c1"># Avoid ends</span>
                <span class="k">if</span> <span class="n">lix</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">lix</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># Get sub-array of spectrum</span>
                <span class="n">cutout</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lix</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">lix</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">xct</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">cutout</span><span class="p">]</span>               <span class="c1"># Position (x)</span>
                <span class="n">sct</span> <span class="o">=</span> <span class="n">lampspec</span><span class="p">[</span><span class="n">cutout</span><span class="p">]</span>          <span class="c1"># Flux (y)</span>

                <span class="c1"># Initial guess for fit</span>
                <span class="n">parguess</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sct</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">sct</span><span class="o">.</span><span class="n">min</span><span class="p">()},</span>     <span class="c1"># Scale</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xct</span><span class="p">[</span><span class="n">sct</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]},</span>       <span class="c1"># Centroid!!</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">},</span>                     <span class="c1"># Sigma</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sct</span><span class="o">.</span><span class="n">min</span><span class="p">()},</span>               <span class="c1"># offset</span>
                    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]</span>                       <span class="c1"># slope</span>

                <span class="c1"># Do the fitting</span>
                <span class="n">pars</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_do</span><span class="p">(</span><span class="n">resfun</span><span class="p">,</span> <span class="n">xct</span><span class="p">,</span> <span class="n">sct</span><span class="p">,</span> <span class="n">parguess</span><span class="p">,</span>
                                        <span class="n">error</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sct</span><span class="p">)))</span>
                <span class="c1"># Skip bad fits</span>
                <span class="k">if</span> <span class="n">pars</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Gather results for each line in the spectrum</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">,</span> <span class="n">pars</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pars</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="c1"># Print results</span>
                <span class="c1"># if printout:</span>
                    <span class="c1"># out_str = \</span>
                    <span class="c1">#     &quot;\rLine: %7.2f nm, Xpos: %8.3f px, dXpos: %6.3f px&quot; % \</span>
                    <span class="c1">#     (line, pars.params[1], pars.perror[1])</span>
                    <span class="c1"># print(out_str, end=&quot;&quot;)</span>
                    <span class="c1"># sys.stdout.flush()</span>
            <span class="c1"># END: for line in linelist[lampname]:</span>
        <span class="c1"># END: for lampname, lampspec in lamp_spec.items():</span>

        <span class="c1"># Convert results into an numpy array</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Skip if we only solved for fewer than 3 lines</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Break out the parameters</span>
        <span class="n">LS</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>       <span class="c1"># Reference wavelength</span>
        <span class="n">IXS</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>      <span class="c1"># Pixel position of line centroid</span>
        <span class="n">WS</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>       <span class="c1"># Error in position in pixels</span>

        <span class="c1"># Calculate number of coefficients to use in fit</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LS</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># Fit dispersion function</span>
        <span class="n">newcoef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">IXS</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">WS</span><span class="p">)</span>

        <span class="c1"># Residuals</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">IXS</span><span class="p">,</span> <span class="n">newcoef</span><span class="p">)</span> <span class="o">-</span> <span class="n">LS</span><span class="p">)</span>
        <span class="n">nres</span> <span class="o">=</span> <span class="n">res</span><span class="o">/</span><span class="n">LS</span>

        <span class="c1"># Error checking on 365 nm line (not currently used)</span>
        <span class="c1"># if nres[LS==365] &lt; 200:</span>
        <span class="c1">#    sl = np.where(LS==365)[0]</span>
        <span class="c1">#    np.delete(IXS, sl)</span>
        <span class="c1">#    np.delete(LS, sl)</span>
        <span class="c1">#    np.delete(WS, sl)</span>

        <span class="c1">#    newcoef = chebfit(IXS, LS, nc, w=WS)</span>
        <span class="c1">#    res = np.abs(chebval(IXS, newcoef) - LS)</span>
        <span class="c1">#    nres = res/LS</span>

        <span class="k">return</span> <span class="n">newcoef</span><span class="p">,</span> <span class="n">nres</span><span class="p">,</span> <span class="n">res</span>
    <span class="c1"># END: def fitlinelist(cc, printout=False):</span>

    <span class="c1"># Iterate three times on fitting dispersion function</span>
    <span class="n">newcoef</span><span class="p">,</span> <span class="n">nres</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fitlinelist</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
    <span class="n">newcoef</span><span class="p">,</span> <span class="n">newnres</span><span class="p">,</span> <span class="n">newres</span> <span class="o">=</span> <span class="n">fitlinelist</span><span class="p">(</span><span class="n">newcoef</span><span class="p">)</span>
    <span class="n">newcoef</span><span class="p">,</span> <span class="n">newnres</span><span class="p">,</span> <span class="n">newres</span> <span class="o">=</span> <span class="n">fitlinelist</span><span class="p">(</span><span class="n">newcoef</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># return the coefs and the RMS (normalized and unnormalized)</span>
    <span class="k">return</span> <span class="n">newcoef</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">newnres</span><span class="o">*</span><span class="n">newnres</span><span class="p">)),</span> \
           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">newres</span><span class="o">*</span><span class="n">newres</span><span class="p">))</span></div>


<div class="viewcode-block" id="snap_solution_into_place_all"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.snap_solution_into_place_all">[docs]</a><span class="k">def</span> <span class="nf">snap_solution_into_place_all</span><span class="p">(</span><span class="n">fine</span><span class="p">,</span> <span class="n">Hgs</span><span class="p">,</span> <span class="n">Xes</span><span class="p">,</span> <span class="n">Cds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Hes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get a global solution for dispersion function</span>
<span class="sd">    using Hg, Xe, possibly Cd data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="c1"># Data structure for passing to fitting function</span>
    <span class="n">PARS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop over extractions in fine</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fine</span><span class="p">)):</span>

        <span class="c1"># Add an empty record</span>
        <span class="n">PARS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="c1"># Skip bad extractions</span>
        <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mdn_coeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Get X values</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>
        <span class="c1"># Get starting coeffs</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mdn_coeff</span>
        <span class="c1"># Start with Hg and Xe spectra</span>
        <span class="n">lamp_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Hg&quot;</span><span class="p">:</span> <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="s2">&quot;Xe&quot;</span><span class="p">:</span> <span class="n">Xes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">specw</span><span class="p">}</span>

        <span class="c1"># Add Cd and/or He if we have them</span>
        <span class="k">if</span> <span class="n">Cds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lamp_spec</span><span class="p">[</span><span class="s2">&quot;Cd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">specw</span>
        <span class="k">if</span> <span class="n">Hes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lamp_spec</span><span class="p">[</span><span class="s2">&quot;He&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">specw</span>

        <span class="c1"># Populate with X-values, coefficients, and spectra</span>
        <span class="n">PARS</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">lamp_spec</span><span class="p">)</span>
    <span class="c1"># END: for i in range(len(fine)):</span>

    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARS</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># Map onto thread pool</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">snap_solution_into_place</span><span class="p">,</span> <span class="n">PARS</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># print(&quot;&quot;)</span>

    <span class="c1"># Calculate diagnostics of fits</span>
    <span class="n">min_rms</span> <span class="o">=</span> <span class="mf">1.e9</span>
    <span class="n">max_rms</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">good_rms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># loop over fits</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>

        <span class="c1"># Re-populate fine cube</span>
        <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="c1"># Fit coefficients</span>
        <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamnrms</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># Normalized RMS</span>
        <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamrms</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>         <span class="c1"># Un-normalized RMS (nm)</span>

        <span class="c1"># If we have a good fit</span>
        <span class="k">if</span> <span class="n">fine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

            <span class="c1"># Compile residuals</span>
            <span class="n">good_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">:</span>
                <span class="n">max_rms</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">min_rms</span> <span class="o">&gt;</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">min_rms</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># END: for i, res in enumerate(results):</span>

    <span class="c1"># Calculated and report RMS statistics</span>
    <span class="n">avg_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">good_rms</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;RMS&gt;: </span><span class="si">%8.3f</span><span class="s2"> nm, RMS(min): </span><span class="si">%8.3f</span><span class="s2"> nm, RMS(max): </span><span class="si">%8.3f</span><span class="s2"> nm&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">avg_rms</span><span class="p">,</span>
                                                                       <span class="n">min_rms</span><span class="p">,</span>
                                                                       <span class="n">max_rms</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fine</span></div>


<div class="viewcode-block" id="fit_he_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_he_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_he_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="o">=</span><span class="p">{</span><span class="mf">587.5</span><span class="p">:</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mf">667.8</span><span class="p">:</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="mf">706.5</span><span class="p">:</span> <span class="o">-</span><span class="mi">60</span><span class="p">},</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">Ncutout</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fit_known_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">Ncutout</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_cd_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_cd_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_cd_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="o">=</span><span class="p">{</span><span class="mf">467.8</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span> <span class="mf">479.9</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="mf">508.5</span><span class="p">:</span> <span class="mi">18</span><span class="p">},</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">Ncutout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fit_known_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">Ncutout</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_hg_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_hg_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_hg_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="o">=</span><span class="p">{</span><span class="mi">578</span><span class="p">:</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mf">546.1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">404.6</span><span class="p">:</span> <span class="mi">81</span><span class="p">},</span>
                 <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">Ncutout</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fit_known_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">Ncutout</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_xe_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_xe_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_xe_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="o">=</span><span class="p">{</span><span class="mi">764</span><span class="p">:</span> <span class="o">-</span><span class="mi">77</span><span class="p">,</span> <span class="mi">828</span><span class="p">:</span> <span class="o">-</span><span class="mi">93</span><span class="p">},</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">Ncutout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fit_known_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">Ncutout</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_known_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_known_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_known_lines</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">Ncutout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fit line positions based on guess pixel positions against a fiducial spectrum </span>

<span class="sd">    This function is mapable</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        SS is a list of two elements containting:</span>
<span class="sd">            spix(int[Ns]): Index values (pixel) of spec</span>
<span class="sd">            spec(float[Ns]): Flux from corresponding index values</span>
<span class="sd">        guesses: Dictionary containing {wavelength in nm: pixel guess position}</span>
<span class="sd">    Returns:</span>
<span class="sd">        [ (wavelength in nm, centroid position in pixel) ] with length </span>
<span class="sd">            len(guesses.keys()).</span>

<span class="sd">        Intent is for this list to be fit with polynomials to construct the</span>
<span class="sd">        wavelength solution.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">SS</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Break out parameters</span>
    <span class="n">spix</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">SS</span>

    <span class="c1"># Array for results</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Use 5-parameter Gaussian to fit line peaks</span>
    <span class="n">fitfun</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">gaussian5</span>
    <span class="n">resfun</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_residuals</span><span class="p">(</span><span class="n">fitfun</span><span class="p">)</span>

    <span class="c1"># Loop over lines to fit</span>
    <span class="k">for</span> <span class="n">lam</span><span class="p">,</span> <span class="n">guesspos</span> <span class="ow">in</span> <span class="n">guesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># Get sub-array of line to fit</span>
        <span class="n">cutout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spix</span> <span class="o">-</span> <span class="n">guesspos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Ncutout</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xct</span> <span class="o">=</span> <span class="n">spix</span><span class="p">[</span><span class="n">cutout</span><span class="p">]</span>      <span class="c1"># Line position (X)</span>
        <span class="n">sct</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">cutout</span><span class="p">]</span>      <span class="c1"># Line flux (Y)</span>

        <span class="c1"># Initial guess at fit parameters</span>
        <span class="n">parguess</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sct</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">sct</span><span class="o">.</span><span class="n">min</span><span class="p">()},</span>     <span class="c1"># Scale</span>
            <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xct</span><span class="p">[</span><span class="n">sct</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]},</span>       <span class="c1"># Centroid!!</span>
            <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">},</span>                     <span class="c1"># Sigma</span>
            <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sct</span><span class="o">.</span><span class="n">min</span><span class="p">()},</span>               <span class="c1"># offset</span>
            <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]</span>                       <span class="c1"># slope</span>

        <span class="c1"># Do the peak fitting</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_do</span><span class="p">(</span><span class="n">resfun</span><span class="p">,</span> <span class="n">xct</span><span class="p">,</span> <span class="n">sct</span><span class="p">,</span> <span class="n">parguess</span><span class="p">)</span>

        <span class="c1"># Skip bad fits</span>
        <span class="k">if</span> <span class="n">pars</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Store results: ref wavelength, and centroid</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lam</span><span class="p">,</span> <span class="n">pars</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="c1"># END: for lam, guesspos in guesses.items():</span>

    <span class="c1"># Convert results into numpy array</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="fit_all_lines"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_all_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_all_lines</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">hg_spec</span><span class="p">,</span> <span class="n">xe_spec</span><span class="p">,</span> <span class="n">xxs</span><span class="p">,</span> <span class="n">cd_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">he_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit mercury + xenon lines to a set of spectra that are put on a common fiducial grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        fiducial(int[Nf]): Fiducial index values range from about -130 to + 130</span>
<span class="sd">        hg_spec(Extraction[Ne]): Mercury spectra</span>
<span class="sd">        xe_spec(Extraction[Ne]): Xenon spectra</span>
<span class="sd">        xxs(Gridded[Ne]): Results from stretch_set() call</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">n_done</span><span class="p">,</span> <span class="n">update_rate</span>

    <span class="c1"># Verify that all extractions share the same dimensionality</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xe_spec</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cd_spec</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">he_spec</span><span class="p">))</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xxs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">))</span>

    <span class="c1"># Arrays in which to accumulate extracted spectra</span>
    <span class="n">Hgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Xes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Hes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Stretching spectra&quot;</span><span class="p">)</span>

    <span class="c1"># Loop over extracted spectra</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)):</span>

        <span class="c1"># Placeholders for bad extractions</span>
        <span class="k">if</span> <span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">xxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Hgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">Xes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">Cds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">Hes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Stretch using Hg and Xe</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">get_stretched</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">xxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">spec2</span><span class="o">=</span><span class="n">xe_spec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Stretch using Hg and Cd</span>
        <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">get_stretched</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">xxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="n">spec2</span><span class="o">=</span><span class="n">cd_spec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># Store stretched Cd spectra</span>
            <span class="n">Cds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">s3</span><span class="p">))</span>

        <span class="c1"># Stretch using Hg and He</span>
        <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s4</span> <span class="o">=</span> <span class="n">get_stretched</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">xxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="n">spec2</span><span class="o">=</span><span class="n">he_spec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># Store stretched He spectra</span>
            <span class="n">Hes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">s4</span><span class="p">))</span>

        <span class="c1"># Store stretched Hg, Xe spectra</span>
        <span class="n">Hgs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">s1</span><span class="p">))</span>
        <span class="n">Xes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">s2</span><span class="p">))</span>

    <span class="c1"># Now find all the line centroids in stretched spectra</span>

    <span class="c1"># Start with Hg</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting Hg line positions&quot;</span><span class="p">)</span>
    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hgs</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">hg_locs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_hg_lines</span><span class="p">,</span> <span class="n">Hgs</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Now get Xe lines</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting Xe line positions&quot;</span><span class="p">)</span>
    <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xes</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">xe_locs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_xe_lines</span><span class="p">,</span> <span class="n">Xes</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Cd next, if present</span>
    <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting Cd line positions&quot;</span><span class="p">)</span>
        <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Cds</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">cd_locs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_cd_lines</span><span class="p">,</span> <span class="n">Cds</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Finally He, if present</span>
    <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting He line positions&quot;</span><span class="p">)</span>
        <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hes</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bar</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toolbar_width</span><span class="o">=</span><span class="mi">74</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">he_locs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_he_lines</span><span class="p">,</span> <span class="n">Hes</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">Bar</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">mapped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Now fit all lines for dispersion function</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Determining best fit to all lines&quot;</span><span class="p">)</span>

    <span class="c1"># Store results</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Accumulate fit statistics</span>
    <span class="n">mean_rms</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">max_rms</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">min_rms</span> <span class="o">=</span> <span class="mf">1.e9</span>

    <span class="c1"># Loop over spectra</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)):</span>

        <span class="c1"># Placeholders for results</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">rss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="c1"># Get Hg, Xe positions</span>
        <span class="n">hg</span> <span class="o">=</span> <span class="n">hg_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="n">xe_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Ancillary positions, if supplied</span>
        <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">cd_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">he</span> <span class="o">=</span> <span class="n">he_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Check to be sure our data are good</span>
        <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">xe</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">he</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Create fitting input vectors</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Start with Hg, Xe</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">hg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span>     <span class="c1"># Wavelengths</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">hg</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>     <span class="c1"># Positions</span>

            <span class="c1"># Add Cd and He if supplied</span>
            <span class="k">if</span> <span class="n">cd_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ll</span><span class="p">,</span> <span class="n">cd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span> <span class="n">cd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">he_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ll</span><span class="p">,</span> <span class="n">he</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span> <span class="n">he</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># Skip if we can&#39;t concatenate</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Get fitting weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.03</span>          <span class="c1"># Lower weight for extreme blue</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">860</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>           <span class="c1"># Lower weight for extreme red</span>

        <span class="c1"># Calculate number of coefficients for fit</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Fit dispersion</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Store fit coefficients</span>
        <span class="n">fits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>

        <span class="c1"># Calculate residuals</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jx</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">[</span><span class="n">jx</span><span class="p">],</span> <span class="n">ff</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span>
        <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span> <span class="o">-</span> <span class="n">ll</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">mean_rms</span> <span class="o">+=</span> <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_rms</span><span class="p">:</span>
            <span class="n">min_rms</span> <span class="o">=</span> <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_rms</span><span class="p">:</span>
            <span class="n">max_rms</span> <span class="o">=</span> <span class="n">rss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">ff</span><span class="p">),</span> <span class="n">Hgs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Hes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Xes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">fiducial</span><span class="p">,</span> <span class="n">ff</span><span class="p">),</span> <span class="n">Hgs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Hes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Xes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">XS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">YS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">CS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yrange</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">rss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">XS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">YS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">XS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">YS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">CS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">mean_rms</span> <span class="o">/=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hg_spec</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;RMS&gt;: </span><span class="si">%8.3f</span><span class="s2"> nm, RMS(min): </span><span class="si">%8.3f</span><span class="s2"> nm, RMS(max): </span><span class="si">%8.3f</span><span class="s2"> nm&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">mean_rms</span><span class="p">,</span> <span class="n">min_rms</span><span class="p">,</span> <span class="n">max_rms</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fits</span><span class="p">),</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rss</span><span class="p">),</span> <span class="p">(</span><span class="n">XS</span><span class="p">,</span> <span class="n">YS</span><span class="p">)</span></div>


<div class="viewcode-block" id="coeffs_to_spec"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.coeffs_to_spec">[docs]</a><span class="k">def</span> <span class="nf">coeffs_to_spec</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="n">gridded</span><span class="p">,</span> <span class="n">rgrd_coef</span><span class="p">,</span> <span class="n">lam_coef</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the spectrum given the unadultered spectrum and fits.</span>

<span class="sd">    Args:</span>
<span class="sd">        fix(array) -- Fiducial index positions</span>
<span class="sd">        gridded(Extraction) -- Extracted spectrum to plot</span>
<span class="sd">        rgrd_coef(list) -- Chebyshev polynomial coefficients that represent</span>
<span class="sd">            the stretch of the spectrum to put onto the fiducial index</span>
<span class="sd">            array (fix)</span>
<span class="sd">        lam_coef(list) -- Chebyshev polynomial coefficients that convert</span>
<span class="sd">            fix to wavelength in nm</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple containing the wavelength and spectrum</span>
<span class="sd">        (wavelength, spectrum) this is in the units of the fit coefficients.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">gix</span> <span class="o">=</span> <span class="n">scale_on_547</span><span class="p">(</span><span class="n">gridded</span><span class="p">)</span>
    <span class="n">gsp</span> <span class="o">=</span> <span class="n">gridded</span><span class="o">.</span><span class="n">specw</span>
    <span class="n">newix</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="n">rgrd_coef</span><span class="p">)</span>

    <span class="n">CC</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">newix</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">gix</span><span class="p">,</span> <span class="n">CC</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">lam_coef</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LL</span><span class="p">,</span> <span class="n">gsp</span></div>


<div class="viewcode-block" id="plot_grid"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.plot_grid">[docs]</a><span class="k">def</span> <span class="nf">plot_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">Xes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">800</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">900</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">hgcoef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span>
        <span class="n">ix_547</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">hgcoef</span><span class="p">)</span> <span class="o">-</span> <span class="mi">547</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ix_547</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">ix_547</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">ixs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ix_547</span><span class="p">)</span>

        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="p">))</span> <span class="o">-</span> <span class="n">ix_547</span>

        <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">Xes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">=</span> <span class="n">Xes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">specw</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">add</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">specw</span><span class="o">+</span><span class="n">add</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span></div>


<div class="viewcode-block" id="rough_grid_helper"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.rough_grid_helper">[docs]</a><span class="k">def</span> <span class="nf">rough_grid_helper</span><span class="p">(</span><span class="n">ix</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">extractions</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">n_ext</span><span class="p">,</span> <span class="n">tot_std</span><span class="p">,</span> <span class="n">min_std</span><span class="p">,</span> <span class="n">max_std</span>

    <span class="n">ex</span> <span class="o">=</span> <span class="n">extractions</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="o">.</span><span class="n">ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ex</span><span class="o">.</span><span class="n">bkg_ok</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">hg_lines</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">hg_lines</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">X</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="n">xrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">:</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">continue</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">hg_lines</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># print(ex.xrange, ex.yrange, ex.hg_lines)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polyutils</span><span class="o">.</span><span class="n">RankWarning</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>

    <span class="n">ex</span><span class="o">.</span><span class="n">hgcoef</span> <span class="o">=</span> <span class="n">coef</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span>

    <span class="n">rough_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="n">tot_std</span> <span class="o">+=</span> <span class="n">rough_std</span>
    <span class="n">n_ext</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">rough_std</span> <span class="o">&gt;</span> <span class="n">max_std</span><span class="p">:</span>
        <span class="n">max_std</span> <span class="o">=</span> <span class="n">rough_std</span>

    <span class="k">if</span> <span class="n">rough_std</span> <span class="o">&lt;</span> <span class="n">min_std</span><span class="p">:</span>
        <span class="n">min_std</span> <span class="o">=</span> <span class="n">rough_std</span></div>

    <span class="c1"># outstr = &quot;\r%4.4i: rough RMS: %6.3f nm&quot; % (ex.seg_id, np.std(err))</span>
    <span class="c1"># print(outstr,)</span>
    <span class="c1"># sys.stdout.flush()</span>


<div class="viewcode-block" id="rough_grid"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.rough_grid">[docs]</a><span class="k">def</span> <span class="nf">rough_grid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">the_lines</span><span class="o">=</span><span class="p">[</span><span class="mf">365.0</span><span class="p">,</span> <span class="mf">404.6</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">,</span> <span class="mf">546.1</span><span class="p">,</span> <span class="mi">578</span><span class="p">],</span>
               <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;rough_wavelength.npy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shift the extractions onto a coarse common pixel grid&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">extractions</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">n_ext</span><span class="p">,</span> <span class="n">tot_std</span><span class="p">,</span> <span class="n">min_std</span><span class="p">,</span> <span class="n">max_std</span>

    <span class="n">extractions</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">the_lines</span>
    <span class="n">tot_std</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">min_std</span> <span class="o">=</span> <span class="mf">1.e9</span>
    <span class="n">max_std</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">n_ext</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extractions</span><span class="p">)):</span>
        <span class="n">rough_grid_helper</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_ext</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">avg_std</span> <span class="o">=</span> <span class="n">tot_std</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">n_ext</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning - no good extractions&quot;</span><span class="p">)</span>
        <span class="n">avg_std</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;STD&gt;: </span><span class="si">%6.3f</span><span class="s2"> nm, STD(min): </span><span class="si">%6.3f</span><span class="s2"> nm, STD(max): </span><span class="si">%6.3f</span><span class="s2"> nm&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">avg_std</span><span class="p">,</span> <span class="n">min_std</span><span class="p">,</span> <span class="n">max_std</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">extractions</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">extractions</span></div>


<div class="viewcode-block" id="RMS"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.RMS">[docs]</a><span class="k">def</span> <span class="nf">RMS</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">vec</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="fit_spectra_Hg_Xe"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.fit_spectra_Hg_Xe">[docs]</a><span class="k">def</span> <span class="nf">fit_spectra_Hg_Xe</span><span class="p">(</span><span class="n">Hgs</span><span class="p">,</span> <span class="n">Xes</span><span class="p">,</span> <span class="n">kdtree</span><span class="p">,</span> <span class="n">kdseg_ids</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;fit_spectra&#39;</span><span class="p">):</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hgs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">spec_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hgs</span><span class="p">)):</span>
        <span class="n">hg</span> <span class="o">=</span> <span class="n">Hgs</span><span class="p">[</span><span class="n">spec_ix</span><span class="p">]</span>
        <span class="n">xe</span> <span class="o">=</span> <span class="n">Xes</span><span class="p">[</span><span class="n">spec_ix</span><span class="p">]</span>
        <span class="c1"># seg_id = hg.seg_id</span>

        <span class="n">coeff</span> <span class="o">=</span> <span class="n">hg</span><span class="o">.</span><span class="n">hgcoef</span>
        <span class="k">if</span> <span class="n">coeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">spec_ix</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">prev_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>

            <span class="n">offsets</span> <span class="o">=</span> <span class="n">measure_offsets</span><span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">specw</span><span class="o">+</span><span class="n">xe</span><span class="o">.</span><span class="n">specw</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="c1"># keys = np.array(offsets.keys())</span>
            <span class="c1"># vals = np.array(offsets.values())</span>
            <span class="c1"># print(np.sort(keys+vals))</span>

            <span class="n">lams</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ixs</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
            <span class="n">pixs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">lam</span><span class="p">,</span> <span class="n">off</span> <span class="ow">in</span> <span class="n">offsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">off</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">340</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="n">lams</span><span class="p">))]</span>
                <span class="n">pixs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
                <span class="n">meas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">off</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">meas</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pixs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">pixs</span><span class="p">,</span> <span class="n">meas</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">pixs</span><span class="p">,</span> <span class="n">meas</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">pixs</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span> <span class="o">-</span> <span class="n">meas</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">RMS</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="c1"># print(&quot;%4.0i %6.3f&quot; % (spec_ix, rms))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rms</span><span class="p">):</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">rms</span> <span class="o">&lt;</span> <span class="mf">0.35</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rms</span> <span class="o">-</span> <span class="n">prev_rms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">prev_rms</span> <span class="o">=</span> <span class="n">rms</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">specw</span><span class="p">)),</span> <span class="n">coeff</span><span class="p">)</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">hg</span><span class="o">.</span><span class="n">specw</span><span class="o">+</span><span class="n">xe</span><span class="o">.</span><span class="n">specw</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Hgs</span><span class="p">[</span><span class="n">spec_ix</span><span class="p">]</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">coeff</span>
        <span class="n">Hgs</span><span class="p">[</span><span class="n">spec_ix</span><span class="p">]</span><span class="o">.</span><span class="n">lamrms</span> <span class="o">=</span> <span class="n">rms</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-- </span><span class="si">%4.0i</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spec_ix</span><span class="p">,</span> <span class="n">rms</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">Hgs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Hgs</span></div>


<div class="viewcode-block" id="measure_offsets"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.measure_offsets">[docs]</a><span class="k">def</span> <span class="nf">measure_offsets</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Measure wavelength offsets of Hg and Xe extractions</span>

<span class="sd">    First uses a crude peak finding code to identify the locations of the </span>
<span class="sd">    Xe lines.</span>

<span class="sd">    Then, the two Xe complexes are fit individually</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of {line_wavelength_nm: offset_nm}.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">preffun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">120</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">1e4</span> <span class="o">+</span> <span class="mf">1.</span>
    <span class="n">resfun830</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_residuals</span><span class="p">(</span><span class="n">xe_830nm</span><span class="p">,</span> <span class="n">preffun</span><span class="o">=</span><span class="n">preffun</span><span class="p">)</span>

    <span class="c1"># Preference function is designed to bias against adjusting the </span>
    <span class="n">preffun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">30</span> <span class="o">+</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mf">3e4</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="n">resfun890</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_residuals</span><span class="p">(</span><span class="n">xe_890nm</span><span class="p">,</span> <span class="n">preffun</span><span class="o">=</span><span class="n">preffun</span><span class="p">)</span>
    <span class="n">resfung</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_residuals</span><span class="p">(</span><span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">gaussian5</span><span class="p">)</span>

    <span class="n">pk_pxs</span> <span class="o">=</span> <span class="n">SG</span><span class="o">.</span><span class="n">argrelmax</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pk_lam</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">pk_pxs</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pk_lam</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

    <span class="n">offsets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># resfung parameters:</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">365.0</span><span class="p">,</span> <span class="mf">404.6</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">,</span> <span class="mf">546.1</span><span class="p">,</span> <span class="mi">578</span><span class="p">]):</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="mi">9</span><span class="p">))</span>

        <span class="n">toll</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
        <span class="n">tofit</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toll</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tofit</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.5</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tofit</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span>

        <span class="n">parinfo</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">lam</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:[</span><span class="n">lam</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="n">lam</span><span class="o">+</span><span class="mi">15</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">slope</span><span class="p">}]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_do</span><span class="p">(</span><span class="n">resfung</span><span class="p">,</span> <span class="n">toll</span><span class="p">,</span> <span class="n">tofit</span><span class="p">,</span> <span class="n">parinfo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offsets</span><span class="p">[</span><span class="n">lam</span><span class="p">]</span> <span class="o">=</span> <span class="n">lam</span><span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">guess_lam</span> <span class="o">=</span> <span class="n">pk_lam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="p">((</span><span class="n">guess_lam</span><span class="o">-</span><span class="mi">35</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">guess_lam</span><span class="o">+</span><span class="mi">45</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">lamoffset</span> <span class="o">=</span> <span class="n">guess_lam</span><span class="o">-</span><span class="mi">830</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span> <span class="o">-</span> <span class="n">offset</span>

        <span class="n">parinfo</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">250</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">lamoffset</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_do</span><span class="p">(</span><span class="n">resfun830</span><span class="p">,</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">parinfo</span><span class="p">)</span>
        <span class="n">thell</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">thespec</span> <span class="o">=</span> <span class="n">xe_830nm</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">thell</span><span class="p">)</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thespec</span><span class="o">*</span><span class="n">thell</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thespec</span><span class="p">)</span>
        <span class="n">offsets</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">xe_830nm</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">]),</span> <span class="s1">&#39;x-&#39;</span><span class="p">)</span>

    <span class="n">guess_lam</span> <span class="o">=</span> <span class="n">pk_lam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="p">((</span><span class="n">guess_lam</span><span class="o">-</span><span class="mi">55</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">guess_lam</span><span class="o">+</span><span class="mi">100</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">lamoffset</span> <span class="o">=</span> <span class="n">guess_lam</span><span class="o">-</span><span class="mi">890</span>
        <span class="k">if</span> <span class="n">lamoffset</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">lamoffset</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">lamoffset</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="n">lamoffset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span> <span class="o">-</span> <span class="n">offset</span>
        <span class="n">p930</span> <span class="o">=</span> <span class="mi">500</span>

        <span class="n">parinfo</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">260</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">lamoffset</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span>
                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">p930</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Fit</span><span class="o">.</span><span class="n">mpfit_do</span><span class="p">(</span><span class="n">resfun890</span><span class="p">,</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">parinfo</span><span class="p">)</span>

        <span class="n">thell</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">thespec</span> <span class="o">=</span> <span class="n">xe_890nm</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">thell</span><span class="p">)</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thespec</span><span class="o">*</span><span class="n">thell</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thespec</span><span class="p">)</span>
        <span class="n">offsets</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">perror</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">xe_890nm</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">ll</span><span class="p">[</span><span class="n">ok</span><span class="p">]),</span> <span class="s1">&#39;x-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">offsets</span></div>


<div class="viewcode-block" id="read_spec_loc"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.read_spec_loc">[docs]</a><span class="k">def</span> <span class="nf">read_spec_loc</span><span class="p">(</span><span class="n">spec_loc_fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the structure for the location of each spectrum&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">spec_loc_fname</span><span class="p">)</span></div>


<div class="viewcode-block" id="xe_830nm"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.xe_830nm">[docs]</a><span class="k">def</span> <span class="nf">xe_830nm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Xe complex near 830 nm.</span>

<span class="sd">    See: http://www2.keck.hawaii.edu/inst/lris/arc_calibrations.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sigma</span><span class="p">,</span> <span class="n">lamoffset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">peak</span> <span class="o">=</span> <span class="n">p</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">820.63</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">1000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">828.01</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">834.68</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">840.82</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="n">peak</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="k">return</span> <span class="n">sig</span></div>


<div class="viewcode-block" id="save_fitted_ds9"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.save_fitted_ds9">[docs]</a><span class="k">def</span> <span class="nf">save_fitted_ds9</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s1">&#39;fine&#39;</span><span class="p">):</span>

    <span class="n">ds9</span> <span class="o">=</span> <span class="s1">&#39;physical</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">S</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">xrange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>

        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">)</span>
        <span class="n">invcoeffs</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">pxs</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">([</span><span class="mf">400.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">,</span> <span class="mf">600.</span><span class="p">,</span> <span class="mf">656.3</span><span class="p">,</span> <span class="mf">700.</span><span class="p">,</span> <span class="mf">800.</span><span class="p">,</span> <span class="mf">900.</span><span class="p">],</span> <span class="n">invcoeffs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">px</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pxs</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">px</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">poly</span><span class="p">)(</span><span class="n">X</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ds9</span> <span class="o">+=</span> <span class="s1">&#39;point(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">) # point=cross text={</span><span class="si">%s</span><span class="s1">} color=blue</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">seg_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ds9</span> <span class="o">+=</span> <span class="s1">&#39;point(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">) # point=box color=red</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">ds9</span> <span class="o">+=</span> <span class="s1">&#39;point(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">) # point=circle color=red</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds9</span> <span class="o">+=</span> <span class="s1">&#39;point(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">) # point=cross color=red</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span> <span class="p">,</span><span class="n">Y</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.reg&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ds9</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="xe_890nm"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.xe_890nm">[docs]</a><span class="k">def</span> <span class="nf">xe_890nm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Xe complex near 890 nm.</span>

<span class="sd">    See: http://www2.keck.hawaii.edu/inst/lris/arc_calibrations.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sigma</span><span class="p">,</span> <span class="n">lamoffset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">p937</span> <span class="o">=</span> <span class="n">p</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">881.94</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">1000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">895.22</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">1000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">904.54</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="mi">1900</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">916.26</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">p937</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="mf">937.42</span><span class="o">-</span><span class="n">lamoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="n">peak</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="k">return</span> <span class="n">sig</span></div>


<div class="viewcode-block" id="assign_fit_to_spectra"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Wavelength.assign_fit_to_spectra">[docs]</a><span class="k">def</span> <span class="nf">assign_fit_to_spectra</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">gridded</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">stretch</span><span class="p">,</span> <span class="n">lamfit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Put wavelength solution into target</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        target(list of Extraciton): Target list of extractions</span>
<span class="sd">        gridded(list of Extractions[Ne]): Gridded spectra</span>
<span class="sd">        rss (list of float[Ne]): RSS wavelength fit error</span>
<span class="sd">        fix (list of float): Fiducial spectral index  for &quot;stretch&quot;</span>
<span class="sd">        stretch (list of float [Ne x Nfloat]): Float polynomials to stretch</span>
<span class="sd">        spectra onto</span>
<span class="sd">        lamfit (list of float [Ne x Ncoeff]): Wavelength fitting function</span>
<span class="sd">        coefficients</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        New grid with coefficients assigned to it</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gridded</span><span class="p">)):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">coeffs_to_spec</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="n">gridded</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stretch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lamfit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cc</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xrange</span><span class="p">),</span> <span class="n">L</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">cc</span>
        <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lamrms</span> <span class="o">=</span> <span class="n">rss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">target</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span>
    <span class="sd">&quot;&quot;&quot;Wavelength.py performs:</span>

<span class="sd">        1. Rough wavelength calibration based on Mercury lamp lines.</span>
<span class="sd">        2. Fine wavelength calbiration based on Xenon and Mercury lamp lines.</span>
<span class="sd">        3. Extraction of spectra with a fine wavelength calibration.</span>

<span class="sd">        For each step, various report files are written, often ds9 region </span>
<span class="sd">        files.</span>

<span class="sd">        the _coarse.npy file contains a length-1 list with a dictionary. The</span>
<span class="sd">            dictionary contains {wavelength: [(XY point)]} with all XY points</span>
<span class="sd">            for a given Hg emission line wavelength.</span>

<span class="sd">        the assoc_Hg.npy file contains a length-1 list with the associated</span>
<span class="sd">            Hg solutions from the above *_coarse file. </span>

<span class="sd">        --dome comes from FindSpectra.py</span>

<span class="sd">        for rough set --dome [npy], --hgcat [txt], and --outname </span>
<span class="sd">        for fine set --xefits [fits], --hefits [fits] --cdfits [fits] --hgassoc [npy], and --outname</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;One of [rough|fine|extract]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--infile&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Infile name, purpose depends on step&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dome&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dome segment definition npy file. Used in rough.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hgfits&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of mercury fits file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--xefits&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of xenon fits file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cdfits&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of cadmium fits file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hefits&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of helium fits file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hgcat&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of mercury sextractor catalog&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--coarse&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of coarse Hg solution [npy]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hgassoc&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of coarse Hg solution [npy]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fine&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of fine solution [npy]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--toextract&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of fine solution [npy]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outname&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Prefix name of output file&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">outname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;rough&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ROUGH WAVELENGTH SOLUTION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hgfits</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hgfits</span>
        <span class="n">catname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hgcat</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">read_catalog</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
        <span class="n">spec_loc_fname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dome</span>
        <span class="n">spec_loc</span> <span class="o">=</span> <span class="n">read_spec_loc</span><span class="p">(</span><span class="n">spec_loc_fname</span><span class="p">)</span>
        <span class="n">hg_spec</span> <span class="o">=</span> <span class="n">find_hg_spectra</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="p">)</span>
        <span class="n">assoc_hg_with_flats</span><span class="p">(</span><span class="n">spec_loc</span><span class="p">,</span> <span class="n">hg_spec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;fine&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FINE WAVELENGTH SOLUTION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">XeDat</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">xefits</span><span class="p">)</span>
        <span class="n">HgDat</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hgfits</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cdfits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">CdDat</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cdfits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CdDat</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">hefits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">HeDat</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hefits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">HeDat</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">assoc_hg_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hgassoc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Extracting Hg&quot;</span><span class="p">)</span>
        <span class="n">Hg_E</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">HgDat</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Hg_ext_&quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Extracting Xe&quot;</span><span class="p">)</span>
        <span class="n">Xe_E</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">XeDat</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Xe_ext_&quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)</span>

        <span class="n">Cd_E</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">CdDat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Extracting Cd&quot;</span><span class="p">)</span>
            <span class="n">Cd_E</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">CdDat</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Cd_ext_&quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)</span>
        <span class="n">He_E</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">HeDat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Extracting He&quot;</span><span class="p">)</span>
            <span class="n">He_E</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">HeDat</span><span class="p">,</span> <span class="n">assoc_hg_spec</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;He_ext_&quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting rough grid&quot;</span><span class="p">)</span>
        <span class="n">gridded</span> <span class="o">=</span> <span class="n">rough_grid</span><span class="p">(</span><span class="n">Hg_E</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting stretched set for Xe&quot;</span><span class="p">)</span>
        <span class="n">stretchset</span><span class="p">,</span> <span class="n">fiducial</span><span class="p">,</span> <span class="n">xcors</span> <span class="o">=</span> <span class="n">stretch_set</span><span class="p">(</span><span class="n">gridded</span><span class="p">,</span> <span class="n">Xe_E</span><span class="p">)</span>
        <span class="n">fix</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fiducial</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fitting all lines&quot;</span><span class="p">)</span>
        <span class="n">fits</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">locs</span> <span class="o">=</span> <span class="n">fit_all_lines</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span>
                                                   <span class="n">gridded</span><span class="p">,</span>
                                                   <span class="n">Xe_E</span><span class="p">,</span>
                                                   <span class="n">stretchset</span><span class="p">,</span>
                                                   <span class="n">cd_spec</span><span class="o">=</span><span class="n">Cd_E</span><span class="p">,</span>
                                                   <span class="n">he_spec</span><span class="o">=</span><span class="n">He_E</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Assigning fit to spectra&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">assign_fit_to_spectra</span><span class="p">(</span><span class="n">Hg_E</span><span class="p">,</span> <span class="n">gridded</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span>
                                       <span class="n">fix</span><span class="p">,</span> <span class="n">stretchset</span><span class="p">,</span> <span class="n">fits</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting median fine grid&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">median_fine_grid</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Snapping solution into place&quot;</span><span class="p">)</span>
        <span class="n">snap_solution_into_place_all</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Hg_E</span><span class="p">,</span> <span class="n">Xe_E</span><span class="p">,</span> <span class="n">Cds</span><span class="o">=</span><span class="n">Cd_E</span><span class="p">,</span> <span class="n">Hes</span><span class="o">=</span><span class="n">He_E</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;extract&#39;</span><span class="p">:</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EXTRACTION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fine</span><span class="p">)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">toextract</span><span class="p">)</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>

        <span class="n">ww</span> <span class="o">=</span> <span class="n">wavelength_extract</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
            <span class="n">inname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">toextract</span><span class="p">)</span>
        <span class="n">ww</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">ww</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Nick Konidaris, Don Neill, Nadia Blagorodnova.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>