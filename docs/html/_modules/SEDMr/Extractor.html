<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SEDMr.Extractor &mdash; SEDM Pipeline 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SEDM Pipeline 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for SEDMr.Extractor</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial.chebyshev</span> <span class="kn">import</span> <span class="n">chebfit</span><span class="p">,</span> <span class="n">chebval</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">filters</span>
<span class="kn">import</span> <span class="nn">SEDMr.Wavelength</span> <span class="kn">as</span> <span class="nn">Wavelength</span>
<span class="kn">import</span> <span class="nn">SEDMr.Spectra</span> <span class="kn">as</span> <span class="nn">SedSpec</span>
<span class="kn">import</span> <span class="nn">SEDMr.GUI</span> <span class="kn">as</span> <span class="nn">GUI</span>
<span class="kn">import</span> <span class="nn">NPK.Util</span>
<span class="kn">import</span> <span class="nn">NPK.Standards</span> <span class="kn">as</span> <span class="nn">Stds</span>
<span class="kn">import</span> <span class="nn">NPK.Atmosphere</span> <span class="kn">as</span> <span class="nn">Atm</span>

<span class="c1"># Nadia imports</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">opt</span>


<div class="viewcode-block" id="reject_outliers"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.reject_outliers">[docs]</a><span class="k">def</span> <span class="nf">reject_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">2.</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">mdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="n">d</span> <span class="o">!=</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100000.</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="n">mdev</span> <span class="k">if</span> <span class="n">mdev</span> <span class="k">else</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_ellipse_xys"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.get_ellipse_xys">[docs]</a><span class="k">def</span> <span class="nf">get_ellipse_xys</span><span class="p">(</span><span class="n">ell</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">361</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="n">ell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
    <span class="n">sin_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">cos_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.</span><span class="p">:</span><span class="mf">360.</span><span class="p">:</span><span class="mi">1j</span> <span class="o">*</span> <span class="mi">361</span><span class="p">])</span>

    <span class="n">sin_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">cos_alpha</span> <span class="o">*</span> <span class="n">cos_beta</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">sin_beta</span><span class="p">)</span>
    <span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">cos_alpha</span> <span class="o">*</span> <span class="n">sin_beta</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">cos_beta</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pts</span></div>


<div class="viewcode-block" id="atm_dispersion_positions"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.atm_dispersion_positions">[docs]</a><span class="k">def</span> <span class="nf">atm_dispersion_positions</span><span class="p">(</span><span class="n">prlltc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">leff</span><span class="p">,</span> <span class="n">airmass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return list of (X,Y) positions indicating trace of</span>
<span class="sd">    atmospheric dispersion</span>

<span class="sd">    Args:</span>
<span class="sd">        prlltc (float): parralactic angle in Angle class</span>
<span class="sd">        pos (float,float): (x,y) position of source in arcsec at wave leff</span>
<span class="sd">        leff (float): Effective wavelength, micron</span>
<span class="sd">        airmass (float): Atmospheric airmass, airmass=1 means no dispersion</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): List of source positions in arcsec: [ (x0,y0) ... (xn,yn) ]</span>

<span class="sd">        Note: if airmass=1, then the list is equivalent of [ pos ]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;LamEff </span><span class="si">%.1f</span><span class="s2"> microns, Airmass </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">leff</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>

    <span class="c1"># Compute the AD for two pieces of the spectrum:</span>
    <span class="c1"># from 0.38 microns to leff and from leff to 0.95 microns</span>
    <span class="n">blue_ad</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">atm_disper</span><span class="p">(</span><span class="mf">0.38</span><span class="p">,</span> <span class="n">leff</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>
    <span class="n">red_ad</span> <span class="o">=</span> <span class="n">NPK</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">atm_disper</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">leff</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;Blue AD is </span><span class="si">%1.1f</span><span class="s1">&quot;, Red AD is </span><span class="si">%1.1f</span><span class="s1">&quot; PRLLTC </span><span class="si">%3.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blue_ad</span><span class="p">,</span> <span class="n">red_ad</span><span class="p">,</span>
                                                                <span class="n">prlltc</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">prlltc</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">prlltc</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">bpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">])</span> <span class="o">*</span> <span class="n">blue_ad</span>  <span class="c1"># * delta</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nstep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">blue_ad</span> <span class="o">-</span> <span class="n">red_ad</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nstep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nstep</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">bpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="n">bpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">delta</span><span class="p">]</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">print</span> <span class="s2">&quot;DX </span><span class="si">%2.1f</span><span class="s2">, DY </span><span class="si">%2.1f</span><span class="s2">, D </span><span class="si">%2.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">positions</span></div>


<div class="viewcode-block" id="gaussian_2d"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.gaussian_2d">[docs]</a><span class="k">def</span> <span class="nf">gaussian_2d</span><span class="p">(</span><span class="n">xdata_tuple</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span>
                <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces a 2D gaussian centered in xo, yo with the parameters specified.</span>
<span class="sd">    xdata_tuple: coordinates of the points where the 2D Gaussian is computed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xdata_tuple</span>
    <span class="n">xo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
    <span class="n">yo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>


<div class="viewcode-block" id="identify_spectra_gauss_fit"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.identify_spectra_gauss_fit">[docs]</a><span class="k">def</span> <span class="nf">identify_spectra_gauss_fit</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">prlltc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mf">400.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">900.</span><span class="p">,</span>
                               <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sigfac</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Returns index of spectra picked by Guassian fit.</span>
<span class="sd">    </span>
<span class="sd">    NOTE: Index is counted against the array, not seg_id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

    <span class="n">kt</span> <span class="o">=</span> <span class="n">SedSpec</span><span class="o">.</span><span class="n">Spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>

    <span class="c1"># Get X,Y positions (arcsec) and summed values between lmin and lmax</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">to_xyv</span><span class="p">(</span><span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span><span class="mi">100j</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span><span class="mi">200j</span><span class="p">]</span>

    <span class="n">points</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">vs</span>

    <span class="n">grid_vs</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="n">grid_vs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;grid_vs min, max, mean: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">)))</span>

    <span class="c1"># pl.plot(np.nansum(grid_vs, axis=1))</span>
    <span class="c1"># pl.plot(np.nansum(grid_vs, axis=0))</span>
    <span class="c1"># pl.show()</span>
    <span class="c1"># Initialize the first guess for the Gaussian</span>
    <span class="n">xo</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>
    <span class="n">yo</span> <span class="o">=</span> <span class="n">yi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
    <span class="n">sigma_x</span> <span class="o">=</span> <span class="mf">1.3</span>
    <span class="n">sigma_y</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;initial guess: z,a,b,x,y,theta: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>

    <span class="c1"># create data</span>
    <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">grid_vs</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">gaussian_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                                   <span class="n">grid_vs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;ERROR: unable to fit Gaussian&quot;</span>
        <span class="k">print</span> <span class="s2">&quot;Using initial guess&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="n">initial_guess</span>

    <span class="n">xc</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">xc</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">30.</span> <span class="ow">or</span> <span class="n">xc</span> <span class="o">&gt;</span> <span class="mf">30.</span> <span class="ow">or</span> <span class="n">yc</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">30.</span> <span class="ow">or</span> <span class="n">yc</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;ERROR: X,Y out of bounds: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Using initial position: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">xo</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yo</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">)</span>

    <span class="c1"># get 3-sigma extent</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">sigfac</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">sigfac</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mf">30.</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;ERROR: A,B out of bounds: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Using initial values: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">sigma_x</span> <span class="o">*</span> <span class="n">sigfac</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">sigma_y</span> <span class="o">*</span> <span class="n">sigfac</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># report position and shape</span>
    <span class="n">ellipse</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;PSF FIT on IFU:  z,a,b,x,y,theta = </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">theta</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="n">leffmic</span> <span class="o">=</span> <span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="n">lmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2000.0</span>    <span class="c1"># convert to microns</span>

    <span class="k">if</span> <span class="n">prlltc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">atm_dispersion_positions</span><span class="p">(</span><span class="n">prlltc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">leffmic</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">]</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">the_pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
        <span class="n">all_kix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">find_positions_ellipse</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">KT</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="n">theta</span><span class="p">)))</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="k">print</span> <span class="s2">&quot;found this many spaxels: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">kix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="p">[</span><span class="n">kix</span><span class="p">],</span> <span class="n">pos</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">status</span></div>


<div class="viewcode-block" id="find_positions_ellipse"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.find_positions_ellipse">[docs]</a><span class="k">def</span> <span class="nf">find_positions_ellipse</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xy: Vector with pairs [[x0, y0], [x1, y1]] of coordinates.</span>
<span class="sd">    a: semi-major axis of ellipse in X axis.</span>
<span class="sd">    b: semi-minor axis of ellipse in Y axis.</span>
<span class="sd">    h: central point ellipse in X axis.</span>
<span class="sd">    k: central point ellipse in Y axis.</span>
<span class="sd">    theta: angle of rotation of ellipse in radians (clockwise).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
           <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">positions</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="identify_spectra_gui"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.identify_spectra_gui">[docs]</a><span class="k">def</span> <span class="nf">identify_spectra_gui</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bgd_sub</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                         <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=-</span><span class="mi">300</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">prlltc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">objname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns index of spectra picked in GUI.</span>

<span class="sd">    NOTE: Index is counted against the array, not seg_id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set ellipse parameters</span>
    <span class="n">elfl</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;ell_STD-*.npy&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elfl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">inell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">elfl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">inell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="p">(</span><span class="n">inell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">inell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">inell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="n">inell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">inell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">print</span> <span class="s2">&quot;Loaded ellipse parameters from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">elfl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inell</span> <span class="o">=</span> <span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Using default ellipse parameters&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting with a </span><span class="si">%s</span><span class="s2"> arcsec semimajor axis&quot;</span> <span class="o">%</span> <span class="n">radius</span>

    <span class="c1"># Get spectral extractions</span>
    <span class="n">kt</span> <span class="o">=</span> <span class="n">SedSpec</span><span class="o">.</span><span class="n">Spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>

    <span class="c1"># Scale cube</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scaled</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">GUI</span><span class="o">.</span><span class="n">ScaleCube</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span> <span class="n">bgd_sub</span><span class="o">=</span><span class="n">bgd_sub</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                          <span class="n">objname</span><span class="o">=</span><span class="n">objname</span><span class="p">)</span>
        <span class="n">scaled</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">scaled</span>

        <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
            <span class="n">cmin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cmin</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cmax</span>

    <span class="c1"># Print message if needed</span>
    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">message</span>

    <span class="c1"># Get positions</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">GUI</span><span class="o">.</span><span class="n">PositionPicker</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span> <span class="n">bgd_sub</span><span class="o">=</span><span class="n">bgd_sub</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">inell</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span><span class="p">,</span>
                           <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span>
                           <span class="n">objname</span><span class="o">=</span><span class="n">objname</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="n">nosky</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">picked</span>
    <span class="n">nosky</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nosky</span>
    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ellipse</span>

    <span class="k">print</span> <span class="s2">&quot;Final semimajor axis (arcsec) = </span><span class="si">%4.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nosky</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Sky subtraction off&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Sky subtraction on&quot;</span>

    <span class="n">leffmic</span> <span class="o">=</span> <span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="n">lmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2000.0</span>    <span class="c1"># Convert to microns</span>

    <span class="k">if</span> <span class="n">prlltc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">atm_dispersion_positions</span><span class="p">(</span><span class="n">prlltc</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">leffmic</span><span class="p">,</span> <span class="n">airmass</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">]</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">the_pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
        <span class="n">all_kix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">find_positions_ellipse</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">KT</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">ellipse</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                                   <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="o">-</span><span class="n">ellipse</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">))))</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_kix</span><span class="p">))</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nosky&quot;</span><span class="p">:</span> <span class="n">nosky</span><span class="p">,</span> <span class="s2">&quot;scaled&quot;</span><span class="p">:</span> <span class="n">scaled</span><span class="p">,</span>
             <span class="s2">&quot;lmin&quot;</span><span class="p">:</span> <span class="n">lmin</span><span class="p">,</span> <span class="s2">&quot;lmax&quot;</span><span class="p">:</span> <span class="n">lmax</span><span class="p">,</span>
             <span class="s2">&quot;cmin&quot;</span><span class="p">:</span> <span class="n">cmin</span><span class="p">,</span> <span class="s2">&quot;cmax&quot;</span><span class="p">:</span> <span class="n">cmax</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="p">[</span><span class="n">kix</span><span class="p">],</span> <span class="n">pos</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="identify_sky_spectra"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.identify_sky_spectra">[docs]</a><span class="k">def</span> <span class="nf">identify_sky_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">):</span>

    <span class="n">kt</span> <span class="o">=</span> <span class="n">SedSpec</span><span class="o">.</span><span class="n">Spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>

    <span class="c1"># outer = inner + 3.</span>

    <span class="n">skys</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.25</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">ellipse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">the_pos</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">all_kix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">find_positions_ellipse</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">KT</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="n">theta</span><span class="p">)))</span>
    <span class="n">all_kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="p">[</span><span class="n">kix</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">skys</span><span class="p">:</span>
            <span class="n">skys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Number of starting pure sky spaxels is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">skys</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;ERROR: no sky spaxels in this image&quot;</span>

    <span class="n">newspec</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skys</span><span class="p">]</span>
    <span class="n">kt</span> <span class="o">=</span> <span class="n">SedSpec</span><span class="o">.</span><span class="n">Spectra</span><span class="p">(</span><span class="n">newspec</span><span class="p">)</span>

    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">to_xyv</span><span class="p">(</span><span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">)</span>
    <span class="n">vmdn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>

    <span class="n">vstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>

    <span class="n">hi_thresh</span> <span class="o">=</span> <span class="n">vmdn</span> <span class="o">+</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">vstd</span>
    <span class="n">lo_thresh</span> <span class="o">=</span> <span class="n">vmdn</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">vstd</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Median: </span><span class="si">%6.2f</span><span class="s2">, STD: </span><span class="si">%6.2f</span><span class="s2">, Hi Thresh: </span><span class="si">%6.2f</span><span class="s2">, Lo Thresh: </span><span class="si">%6.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">vmdn</span><span class="p">,</span> <span class="n">vstd</span><span class="p">,</span> <span class="n">hi_thresh</span><span class="p">,</span> <span class="n">lo_thresh</span><span class="p">))</span>

    <span class="n">n_hi_rem</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_lo_rem</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_tot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">skys</span><span class="p">:</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get_flambda</span><span class="p">()</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">lmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">lmax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hi_thresh</span><span class="p">:</span>
            <span class="n">skys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">n_hi_rem</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">lo_thresh</span><span class="p">:</span>
            <span class="n">skys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">n_lo_rem</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">n_tot</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">n_tot</span> <span class="o">-=</span> <span class="n">n_hi_rem</span> <span class="o">+</span> <span class="n">n_lo_rem</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> high sky spaxels and </span><span class="si">%d</span><span class="s2"> low sky spaxels leaving </span><span class="si">%d</span><span class="s2"> &quot;</span>
          <span class="s2">&quot;remaining spaxels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_hi_rem</span><span class="p">,</span> <span class="n">n_lo_rem</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">skys</span></div>


<div class="viewcode-block" id="identify_bgd_spectra"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.identify_bgd_spectra">[docs]</a><span class="k">def</span> <span class="nf">identify_bgd_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">expfac</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">kt</span> <span class="o">=</span> <span class="n">SedSpec</span><span class="o">.</span><span class="n">Spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">expfac</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">expfac</span>
    <span class="n">sky_a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">expfac</span>
    <span class="n">sky_b</span> <span class="o">=</span> <span class="n">sky_a</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">the_pos</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">all_kix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">find_positions_ellipse</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">KT</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span>
                                                   <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="n">theta</span><span class="p">)))</span>
    <span class="n">all_kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="p">[</span><span class="n">kix</span><span class="p">]</span>

    <span class="n">all_kix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">the_pos</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">all_kix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">find_positions_ellipse</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">KT</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span>
                                                   <span class="n">sky_a</span><span class="p">,</span> <span class="n">sky_b</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="n">theta</span><span class="p">)))</span>
    <span class="n">all_kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">kix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_kix</span><span class="p">))</span>
    <span class="n">skys</span> <span class="o">=</span> <span class="n">kt</span><span class="o">.</span><span class="n">good_positions</span><span class="p">[</span><span class="n">kix</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">skys</span><span class="p">:</span>
            <span class="n">skys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">skys</span></div>


<div class="viewcode-block" id="to_image"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.to_image">[docs]</a><span class="k">def</span> <span class="nf">to_image</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">posb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">adcpos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">ellipse</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ellipseb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bgd_sub</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert spectra list into image_[outname].pdf</span>

<span class="sd">    Args:</span>
<span class="sd">        spectra (array of extraction): see Extraction.py</span>
<span class="sd">        meta (dict): dictionary of meta-data</span>
<span class="sd">        outname (string): output filename</span>
<span class="sd">        posa (tuple): x,y position of A aperture (asec)</span>
<span class="sd">        posb (tuple): x,y position of B aperture (asec)</span>
<span class="sd">        adcpos (tuple): position offsets due to atmospheric dispersion (asec)</span>
<span class="sd">        ellipse (tuple): ellipse parameters for A aperture</span>
<span class="sd">        ellipseb (tuple): ellipse parameters for B aperture</span>
<span class="sd">        bgd_sub (boolean): set to True to subtract median background</span>
<span class="sd">        lmin (float): minimum wavelength in nm to sum over</span>
<span class="sd">        lmax (float): maximum wavelength in nm to sum over</span>
<span class="sd">        cmin (float): cube intensity minimum for scaling</span>
<span class="sd">        cmax (float): cube intensity maximum for scaling</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">xrange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">specw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">lamcoeff</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="n">lmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="n">lmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="n">vs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">specw</span><span class="p">[</span><span class="n">ok</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">bgd_sub</span><span class="p">:</span>
        <span class="n">vs</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>

    <span class="c1"># Clean outliers</span>
    <span class="n">vcln</span> <span class="o">=</span> <span class="n">reject_outliers</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">m</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">vstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">vcln</span><span class="p">)</span>
    <span class="n">vmid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vcln</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmin</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">posb</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmid</span> <span class="o">-</span> <span class="n">vstd</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmid</span> <span class="o">+</span> <span class="mf">8.</span><span class="o">*</span><span class="n">vstd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmid</span> <span class="o">-</span> <span class="mf">8.</span><span class="o">*</span><span class="n">vstd</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmid</span> <span class="o">+</span> <span class="mf">8.</span><span class="o">*</span><span class="n">vstd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">cmin</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmax</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">sym_size</span> <span class="o">=</span> <span class="mi">70</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">print</span> <span class="s2">&quot;scaling output image between </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">vs</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sym_size</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">posa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">posb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ellipse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ellipseb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipseb</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">adcpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">adcpos</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rx&#39;</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA offset [asec] @ </span><span class="si">%6.1f</span><span class="s2"> nm&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec offset [asec]&quot;</span><span class="p">)</span>
    <span class="n">tlab</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;outname&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;airmass&#39;</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
        <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;, Airmass: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tlab</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;image_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;Wrote image_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span></div>


<div class="viewcode-block" id="c_to_nm"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.c_to_nm">[docs]</a><span class="k">def</span> <span class="nf">c_to_nm</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[:]</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">chebval</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="interp_spectra"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.interp_spectra">[docs]</a><span class="k">def</span> <span class="nf">interp_spectra</span><span class="p">(</span><span class="n">all_spectra</span><span class="p">,</span> <span class="n">six</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">corrfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dnm</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">onto</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sky</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interp spectra onto common grid</span>

<span class="sd">    Args:</span>
<span class="sd">        all_spectra:</span>
<span class="sd">        six:</span>
<span class="sd">        sign:</span>
<span class="sd">        plot:</span>
<span class="sd">        corrfile:</span>
<span class="sd">        outname:</span>
<span class="sd">        dnm: Offset (usually for flexure) in nm</span>
<span class="sd">        onto:</span>
<span class="sd">        sky:</span>
<span class="sd">        percent:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l_grid</span> <span class="o">=</span> <span class="n">onto</span>
    <span class="n">s_grid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_grid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lamcoeff</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># for ix,spectrum in enumerate(all_spectra):</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">six</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">all_spectra</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sky</span> <span class="ow">and</span> <span class="n">all_spectra</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">the_spec</span><span class="o">=</span><span class="s1">&#39;specw&#39;</span><span class="p">)</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>

        <span class="c1"># This is wrong: should give preference to lamcoeff according to Nick</span>
        <span class="c1"># if spectrum.mdn_coeff is not None: cs = spectrum.mdn_coeff</span>
        <span class="c1"># else: cs = spectrum.lamcoeff</span>

        <span class="c1"># This is correct: preference to lamcoeff over mdn_coeff</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mdn_coeff</span>

        <span class="c1"># get wavelengths for spectrum</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">c_to_nm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">dnm</span><span class="p">)</span>

        <span class="c1"># skip short spectra (on or near edge of IFU)</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Positive or negative spectra</span>
        <span class="n">pon</span> <span class="o">=</span> <span class="n">sign</span>

        <span class="c1"># Check if our wavelength grid is defined,</span>
        <span class="k">if</span> <span class="n">l_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># use the first set of wavelengths and store</span>
            <span class="n">l_grid</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">pon</span>
            <span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Interpolate onto our wavelength grid and store</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="o">*</span><span class="n">pon</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">l_grid</span><span class="p">)</span>

        <span class="n">s_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">f_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fl</span><span class="p">[(</span><span class="n">l_grid</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l_grid</span> <span class="o">&lt;</span> <span class="mi">900</span><span class="p">)]))</span>

    <span class="c1"># Are we trimming at a percentile?</span>
    <span class="k">if</span> <span class="n">percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">f_grid</span><span class="p">,</span> <span class="n">percent</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Trimming at </span><span class="si">%.1f</span><span class="s2"> </span><span class="si">%%</span><span class="s2">, flux = </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">f_lim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_lim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;WARNING: If A/B pair, sky level has changed between A and B&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;         Consider single mode extraction&quot;</span>
        <span class="n">l_grid</span> <span class="o">=</span> <span class="n">onto</span>
        <span class="n">s_grid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newsix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lamcoeff</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># for ix,spectrum in enumerate(all_spectra):</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">six</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">all_spectra</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">sky</span> <span class="ow">and</span> <span class="n">all_spectra</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">the_spec</span><span class="o">=</span><span class="s1">&#39;specw&#39;</span><span class="p">)</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">xrange</span><span class="p">)</span>

            <span class="c1"># Preference to lamcoeff over mdn_coeff</span>
            <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mdn_coeff</span>

            <span class="c1"># get wavelengths for spectrum</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">c_to_nm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">dnm</span><span class="p">)</span>

            <span class="c1"># skip short spectra (on or near edge of IFU)</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Positive or negative spectra</span>
            <span class="n">pon</span> <span class="o">=</span> <span class="n">sign</span>

            <span class="c1"># Check if our wavelength grid is defined,</span>
            <span class="k">if</span> <span class="n">l_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># use the first set of wavelengths and store</span>
                <span class="n">l_grid</span> <span class="o">=</span> <span class="n">l</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">pon</span>
                <span class="n">lamcoeff</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Interpolate onto our wavelength grid and store</span>
                <span class="n">fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="n">pon</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">l_grid</span><span class="p">)</span>

            <span class="n">f_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">fl</span><span class="p">[(</span><span class="n">l_grid</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l_grid</span> <span class="o">&lt;</span> <span class="mi">900</span><span class="p">)])</span>

            <span class="k">if</span> <span class="n">f_test</span> <span class="o">&gt;</span> <span class="n">f_lim</span><span class="p">:</span>
                <span class="n">s_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
                <span class="n">newsix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;rejected - ix: </span><span class="si">%d</span><span class="s2">, flx: </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">f_test</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newsix</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># average of all spectra selected</span>
    <span class="n">medspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Output figures if requested</span>

    <span class="c1"># Spectrum</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">l_grid</span><span class="p">,</span> <span class="n">medspec</span><span class="p">)</span>
    <span class="n">yl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="mf">1200.</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [nm]&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">r&#39;Spectral irradiance[photon/10 m/nm]&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Raw Spectrum&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;spec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote spec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Spaxel stack image</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">s_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s_grid</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s_grid</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength bin [pixel]&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Spaxels&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;allspec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote allspec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Package results</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Result contains:</span>
<span class="s2">        nm [N float]: Wavelength solution</span>
<span class="s2">        ph_10m_nm [N float]: Spectral irradiance in units of phot / 10 min / nm</span>
<span class="s2">        spectra [? x K float]: List of all the spectra that participated in</span>
<span class="s2">            the formation of ph_10m_nm. By interpolating these objects onto</span>
<span class="s2">            a ph_10m_nm and taking the mean, you produce ph_10m_nm</span>
<span class="s2">        coefficients [3-5 element float]: Chebyshev coefficents that produce</span>
<span class="s2">            nm. Can be evaluated with numpy chebval().</span>
<span class="s2">        corrected-spec [N float]: ph_10m_nm * Atmospheric correction, if</span>
<span class="s2">            available</span>
<span class="s2">        doc: This doc string</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="n">l_grid</span><span class="p">,</span> <span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">:</span> <span class="n">medspec</span><span class="p">,</span> <span class="s2">&quot;spectra&quot;</span><span class="p">:</span> <span class="n">s_grid</span><span class="p">,</span>
              <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="n">lamcoeff</span><span class="p">,</span> <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}]</span>

    <span class="c1"># Calibrate output if corrfile specified (this is not usually done)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Try to load corrfile</span>
    <span class="k">if</span> <span class="n">corrfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">corrfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Apply correction</span>
    <span class="k">if</span> <span class="n">cc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">corrfun</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">l_grid</span><span class="p">,</span> <span class="n">cc</span><span class="p">[</span><span class="s1">&#39;coeff&#39;</span><span class="p">])</span>
        <span class="n">corrfun</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">corrfun</span><span class="p">)</span>
        <span class="n">corrfun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="s1">&#39;cor&#39;</span><span class="p">],</span>
                           <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">corrfun</span> <span class="o">=</span> <span class="n">corrfun</span><span class="p">(</span><span class="n">l_grid</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;corrected-spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medspec</span> <span class="o">*</span> <span class="n">corrfun</span>

        <span class="c1"># Output corrected spectrum if requested</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">l_grid</span><span class="p">,</span> <span class="n">medspec</span><span class="o">*</span><span class="n">corrfun</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [nm]&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">r&#39;Spectral irradiance[photon/10 m/nm] x Atm correction&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Corr Spectrum&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;corr_spec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;Wrote corr_spec_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">newsix</span></div>


<div class="viewcode-block" id="imarith"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.imarith">[docs]</a><span class="k">def</span> <span class="nf">imarith</span><span class="p">(</span><span class="n">operand1</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">operand2</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">doairmass</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">doexptime</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyraf</span> <span class="kn">import</span> <span class="n">iraf</span>
    <span class="n">iraf</span><span class="o">.</span><span class="n">images</span><span class="p">()</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="n">iraf</span><span class="o">.</span><span class="n">imarith</span><span class="o">.</span><span class="n">getParList</span><span class="p">()</span>
    <span class="n">iraf</span><span class="o">.</span><span class="n">imcombine</span><span class="o">.</span><span class="n">unlearn</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">operand1</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">operand2</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">iraf</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">operand1</span><span class="o">=</span><span class="n">operand1</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">operand2</span><span class="o">=</span><span class="n">operand2</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="n">iraf</span><span class="o">.</span><span class="n">imarith</span><span class="o">.</span><span class="n">setParList</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doairmass</span><span class="p">:</span>
        <span class="c1"># Adjust FITS header</span>
        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">operand1</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">am1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">operand2</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">am2</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>

        <span class="n">of</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">of</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">am1</span>
        <span class="n">of</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">am2</span>
        <span class="n">of</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doexptime</span><span class="p">:</span>
        <span class="c1"># Adjust FITS header</span>
        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">operand1</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ex1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">operand2</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ex2</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>

        <span class="n">of</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">of</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex1</span>
        <span class="n">of</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex2</span>
        <span class="n">of</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="gunzip"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.gunzip">[docs]</a><span class="k">def</span> <span class="nf">gunzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gunzip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gunzip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span></div>


<div class="viewcode-block" id="gzip"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.gzip">[docs]</a><span class="k">def</span> <span class="nf">gzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gzip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gzip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span></div>


<div class="viewcode-block" id="add"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.add">[docs]</a><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gunzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">imarith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">gzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="addcon"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.addcon">[docs]</a><span class="k">def</span> <span class="nf">addcon</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gunzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">imarith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">gzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;junk.gz&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="subtract"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.subtract">[docs]</a><span class="k">def</span> <span class="nf">subtract</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gunzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">imarith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">doairmass</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">gzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="divide"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.divide">[docs]</a><span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gunzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">imarith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">gzip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span></div>


<div class="viewcode-block" id="bgd_level"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.bgd_level">[docs]</a><span class="k">def</span> <span class="nf">bgd_level</span><span class="p">(</span><span class="n">extractions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove background from extractions&quot;&quot;&quot;</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">extractions</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;spec&#39;</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">__dict__</span> <span class="ow">and</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> \
          <span class="ow">and</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lamcoeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

            <span class="n">l</span><span class="p">,</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">the_spec</span><span class="o">=</span><span class="s1">&#39;specw&#39;</span><span class="p">)</span>

            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fl</span><span class="p">))</span>

    <span class="n">bgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">bgd</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">bgd</span><span class="o">+</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">bgd</span><span class="o">-</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="o">*</span><span class="n">sd</span><span class="o">-</span><span class="n">bgd</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">sd</span><span class="o">-</span><span class="n">bgd</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="handle_flat"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.handle_flat">[docs]</a><span class="k">def</span> <span class="nf">handle_flat</span><span class="p">(</span><span class="n">flfile</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads IFU Flat frame &quot;flfile&quot; and extracts spectra using &quot;fine&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        flfile (string): filename of ifu FITS file to extract from.</span>
<span class="sd">        fine (string): filename of NumPy file with locations + wavelength soln.</span>
<span class="sd">        outname (string): filename to write results to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fine</span><span class="p">,</span> <span class="n">fmeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fine</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flfile</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;Extractions already exist in </span><span class="si">%s</span><span class="s2">.npy!&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="k">print</span> <span class="s2">&quot;rm </span><span class="si">%s</span><span class="s2">.npy # if you want to recreate extractions&quot;</span> <span class="o">%</span> <span class="n">outname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CREATING extractions ...&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">flfile</span><span class="p">)</span>

        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting object spectra&quot;</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;HA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_HA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_DEC&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_RA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PRLLTC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_PA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;EQUINOX&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELEQX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;UTC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tjd</span><span class="o">.</span><span class="n">yday</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmeta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span>

        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span></div>


<div class="viewcode-block" id="handle_std"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.handle_std">[docs]</a><span class="k">def</span> <span class="nf">handle_std</span><span class="p">(</span><span class="n">stdfile</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">standard</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">flat_corrections</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">,</span>
               <span class="n">refl</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="mf">18000.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads IFU frame &quot;stdfile&quot; and extracts standard star spectra using &quot;fine&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        stdfile (string): filename of ifu FITS file to extract from.</span>
<span class="sd">        fine (string): filename of NumPy file with locations + wavelength soln</span>
<span class="sd">        outname (string): filename to write results to</span>
<span class="sd">        standard (string): name of standard star</span>
<span class="sd">        offset (2tuple): X (nm)/Y (pix) shift to apply for flexure correction</span>
<span class="sd">        flat_corrections (list): A list of FlatCorrection objects for</span>
<span class="sd">            correcting the extraction</span>
<span class="sd">        lmin (float): lower wavelength limit for image generation</span>
<span class="sd">        lmax (float): upper wavelength limit for image generation</span>
<span class="sd">        refl (float): Telescope reflectance factor (assuming .90 for P60)</span>
<span class="sd">        area (float): Telescope area (assuming 18000. cm^2 for P60)</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>

<span class="sd">    Note:</span>
<span class="sd">        The extracted spectrum dictionary is written to ``outname``.npy::</span>

<span class="sd">            &#39;doc&#39;: docstring description</span>
<span class="sd">            &#39;ph_10m_nm&#39;: Flux in photon/10min/nm integrated</span>
<span class="sd">            &#39;spectra&#39;: Individual spaxel spectra</span>
<span class="sd">            &#39;coefficients&#39;: Coefficients of wavelength fit</span>
<span class="sd">            &#39;nm&#39;: Wavelengths in nm</span>
<span class="sd">            &#39;std-correction&#39;: Correction to standard flux</span>
<span class="sd">            &#39;std-maxnm&#39;: Maximum wavelength that was calibrated</span>
<span class="sd">            &#39;reflectance&#39;: Input reflectance ratio (&lt; 1.0)</span>
<span class="sd">            &#39;area&#39;: Telescope effective area in cm^2</span>
<span class="sd">            &#39;ea&#39;: Effective area of instrument</span>
<span class="sd">            &#39;efficiency&#39;: Overall efficiency of Sky + Telescope + Instrument</span>
<span class="sd">            &#39;dXnm&#39;: Flexure x offset in nm</span>
<span class="sd">            &#39;dYpix&#39;: Flexure y offset in pixels</span>
<span class="sd">            &#39;xfwhm&#39;: Fit FWHM of sky line used to estimate flexure</span>
<span class="sd">            &#39;yfwhm&#39;: Average FWHM of spaxel trace in y direction</span>
<span class="sd">            &#39;exptime&#39;: Total exposure time of observation in seconds</span>
<span class="sd">            &#39;extinction_corr&#39;: Extinction correction for observation</span>
<span class="sd">            &#39;skyph&#39;: Sky flux in photon/10min/nm/spaxel</span>
<span class="sd">            &#39;skynm&#39;: Sky wavelengths in nm</span>
<span class="sd">            &#39;var&#39;: Variance spectrum</span>
<span class="sd">            &#39;radius_as&#39;: Extraction radius in arcsec</span>
<span class="sd">            &#39;position&#39;: Position offset relative to center in arcsec</span>
<span class="sd">            &#39;N_spax&#39;: Number of spaxels summed for target</span>
<span class="sd">            &#39;meta&#39;: Metadata dictionary for extractions</span>
<span class="sd">            &#39;object_spaxel_ids&#39;: Object spaxel IDs for target</span>
<span class="sd">            &#39;sky_spaxel_ids&#39;: Sky spaxel IDS for target</span>
<span class="sd">            &#39;sky_spectra&#39;: Individual sky spaxel spectra</span>
<span class="sd">            &#39;sky_subtraction&#39;: False if no sky subtraction else True</span>
<span class="sd">            &#39;quality&#39;: Estimate of spectral quality (1 = best)</span>
<span class="sd">            &#39;dlam&#39;: Wavelength offsets between samples in nm</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Load wavelength/spatial solution</span>
    <span class="n">fine</span><span class="p">,</span> <span class="n">fmeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fine</span><span class="p">)</span>
    <span class="c1"># Set a default outname if needed</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stdfile</span>
    <span class="c1"># Check for flexure offsets</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Dx </span><span class="si">%2.1f</span><span class="s2"> nm | Dy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;xfwhm&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;FWHMx </span><span class="si">%2.1f</span><span class="s2"> nm | FWHMy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">],</span>
                                                       <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># The spaxel extraction already exist, so load them in</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;USING extractions in </span><span class="si">%s</span><span class="s2">.npy!&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="k">print</span> <span class="s2">&quot;rm </span><span class="si">%s</span><span class="s2">.npy # if you want to recreate extractions&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
    <span class="c1"># No extractions yet, so generate them</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CREATING extractions ...&quot;</span>
        <span class="c1"># Load spectrum image</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stdfile</span><span class="p">)</span>
        <span class="c1"># Set up variance image by adding read noise to Poisson noise</span>
        <span class="n">adcspeed</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ADCSPEED&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">adcspeed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">22</span><span class="o">*</span><span class="mi">22</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">5</span>
        <span class="c1"># Variance image is input image plus read variance</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">addcon</span><span class="p">(</span><span class="n">stdfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">read_var</span><span class="p">),</span> <span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        <span class="c1"># Extract each object spaxel</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting object spectra&quot;</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>
        <span class="c1"># Extract metadata</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;HA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_HA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_DEC&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_RA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PRLLTC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_PA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;EQUINOX&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELEQX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;UTC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tjd</span><span class="o">.</span><span class="n">yday</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmeta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="c1"># Save object extraction</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="c1"># Extract each variance spaxel</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting variance spectra&quot;</span>
        <span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>
        <span class="c1"># Save variance extraction</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote var_</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>

    <span class="c1"># Get the object name of record</span>
    <span class="n">objname</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Automatic extraction using Gaussian fit for Standard Stars</span>
    <span class="n">sixa</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">adcpos</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> \
        <span class="n">identify_spectra_gauss_fit</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span>
                                   <span class="n">prlltc</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
                                   <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                                   <span class="n">airmass</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># something went wrong</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># good fit</span>

    <span class="n">radius_used</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="c1"># Mark object spaxels</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">sixa</span><span class="p">:</span>
        <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># Use all sky spaxels in image for Standard Stars</span>
    <span class="n">kixa</span> <span class="o">=</span> <span class="n">identify_sky_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">)</span>
    <span class="c1"># Mark sky spaxels</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
        <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_sky</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># Make an image of the spaxels for the record</span>
    <span class="n">to_image</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">adcpos</span><span class="o">=</span><span class="n">adcpos</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">,</span>
             <span class="n">bgd_sub</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">)</span>
    <span class="c1"># get the mean spectrum over the selected spaxels</span>
    <span class="n">resa</span><span class="p">,</span> <span class="n">nspxa</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">sixa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
    <span class="n">skya</span><span class="p">,</span> <span class="n">nspxak</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">kixa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_sky.pdf&quot;</span><span class="p">,</span>
                                  <span class="n">sky</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">vara</span><span class="p">,</span> <span class="n">nspxav</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">e_var</span><span class="p">,</span> <span class="n">sixa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_var.pdf&quot;</span><span class="p">)</span>

    <span class="c1"># Plot out the X/Y positions of the selected spaxels</span>
    <span class="n">xsa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ysa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xsk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ysk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">sixa</span><span class="p">:</span>
        <span class="n">xsa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
        <span class="n">ysa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
            <span class="n">xsk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
            <span class="n">ysk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">posa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ellipse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA offset [asec] @ </span><span class="si">%6.1f</span><span class="s2"> nm&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec offset [asec]&quot;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsa</span><span class="p">,</span> <span class="n">ysa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsk</span><span class="p">,</span> <span class="n">ysk</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tlab</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> selected spaxels for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xsa</span><span class="p">),</span> <span class="n">objname</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;airmass&#39;</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
        <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Airmass: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tlab</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;Wrote XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span>
    <span class="c1"># / End Plot</span>

    <span class="c1"># Define our standard wavelength grid</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">Wavelength</span><span class="o">.</span><span class="n">fiducial_spectrum</span><span class="p">()</span>
    <span class="c1"># Resample sky onto standard wavelength grid</span>
    <span class="n">sky_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">sky</span> <span class="o">=</span> <span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="c1"># Resample variance onto standard wavelength grid</span>
    <span class="n">var_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">varspec</span> <span class="o">=</span> <span class="n">var_a</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="c1"># Copy and resample object spectrum onto standard wavelength grid</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;doc&quot;</span><span class="p">],</span> <span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;spectra&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spectra&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;coefficients&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">])}]</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Calculate airmass correction</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
    <span class="n">extcorr</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Atm</span><span class="o">.</span><span class="n">ext</span><span class="p">(</span><span class="n">ll</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">airmass</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;Median airmass corr: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">extcorr</span><span class="p">)</span>
    <span class="c1"># Calculate output corrected spectrum</span>
    <span class="c1"># Account for sky, airmass and aperture</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f1</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">-</span><span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span> <span class="o">*</span> <span class="n">extcorr</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sixa</span><span class="p">)</span>

    <span class="c1"># Process standard star objects</span>
    <span class="k">print</span> <span class="s2">&quot;STANDARD&quot;</span>
    <span class="c1"># Extract reference data</span>
    <span class="n">wav</span> <span class="o">=</span> <span class="n">standard</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">standard</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Flux in photons/s/cm^2/A</span>
    <span class="n">flpho</span> <span class="o">=</span> <span class="mf">5.0341125e-9</span> <span class="o">*</span> <span class="n">flux</span> <span class="o">*</span> <span class="n">wav</span>
    <span class="c1"># convert wav to nm</span>
    <span class="n">wav</span> <span class="o">/=</span> <span class="mf">10.</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="n">flpho</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="c1"># Effective area</span>
    <span class="n">earea</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">600.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">10.</span><span class="p">)</span>
    <span class="c1"># Efficiency assuming given reflectance (refl) and area in cm^2</span>
    <span class="n">eff</span> <span class="o">=</span> <span class="n">earea</span> <span class="o">*</span> <span class="n">refl</span> <span class="o">/</span> <span class="n">area</span>
    <span class="c1"># Calculate/Interpolate correction onto object wavelengths</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="c1"># Divide reference spectrum by observed to get correction</span>
    <span class="n">correction0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span>
    <span class="c1"># Filter for resolution</span>
    <span class="n">flxf</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="mf">19.</span><span class="p">)</span>
    <span class="c1"># Calculate/Interpolate filtered correction</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="n">flxf</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="c1"># Divide reference spectrum by observed to get correction</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span>
    <span class="c1"># Use unfiltered for H-beta region</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">470.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">600.</span><span class="p">)</span>
    <span class="n">correction</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction0</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
    <span class="c1"># Store correction and max calibrated wavelength</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;std-correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correction</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;std-maxnm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;reflectance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refl</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earea</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;efficiency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eff</span>

    <span class="c1"># Store flexure data</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_x_corr_nm</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_y_corr_pix</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfwhm</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfwhm</span>

    <span class="c1"># Store new metadata</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Extinction Correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Applied using Hayes &amp; Latham&#39;</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;extinction_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extcorr</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;skyph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sixa</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;skynm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varspec</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius_as&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_used</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;N_spax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sixa</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;object_spaxel_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sixa</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spaxel_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kixa</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;spectra&#39;</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_subtraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality</span>
    <span class="c1"># Calculate wavelength offsets</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)),</span> <span class="n">ll</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">newll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>
    <span class="c1"># Store offsets</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dlam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">newll</span><span class="p">)</span>
    <span class="c1"># Save the final spectrum</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;sp_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;Wrote sp_&quot;</span><span class="o">+</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span>
    <span class="c1"># Save std star ellipse if all went well</span>
    <span class="k">if</span> <span class="n">quality</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ell_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote ell_</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span></div>


<div class="viewcode-block" id="handle_single"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.handle_single">[docs]</a><span class="k">def</span> <span class="nf">handle_single</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">radius</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">flat_corrections</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">,</span>
                  <span class="n">specExtract</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoExtract</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interact</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads IFU frame &quot;imfile&quot; and extracts spectra using &quot;fine&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        imfile (string): filename of ifu FITS file to extract from.</span>
<span class="sd">        fine (string): filename of NumPy file with locations + wavelength</span>
<span class="sd">            soln</span>
<span class="sd">        outname (string): filename to write results to</span>
<span class="sd">        offset (2tuple): X (nm)/Y (pix) shift to apply for flexure correction</span>
<span class="sd">        radius (float): Extraction radius in arcsecond</span>
<span class="sd">        flat_corrections (list): A list of FlatCorrection objects for</span>
<span class="sd">            correcting the extraction</span>
<span class="sd">        nosky (Boolean): if True don&#39;t subtract sky, merely sum in aperture</span>
<span class="sd">        lmin (float): lower wavelength limit for image generation</span>
<span class="sd">        lmax (float): upper wavelength limit for image generation</span>
<span class="sd">        specExtract (Boolean): perform extraction to a spectrum?</span>
<span class="sd">        autoExtract (Boolean): automatically find source?</span>
<span class="sd">        interact (Boolean): Interactively set the quality of the extraction?</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>

<span class="sd">    Note:</span>
<span class="sd">        The extracted spectrum dictionary is written to ``outname``.npy::</span>

<span class="sd">            &#39;doc&#39;: docstring description</span>
<span class="sd">            &#39;ph_10m_nm&#39;: Flux in photon/10min/nm integrated</span>
<span class="sd">            &#39;spectra&#39;: Individual spaxel spectra</span>
<span class="sd">            &#39;coefficients&#39;: Coefficients of wavelength fit</span>
<span class="sd">            &#39;nm&#39;: Wavelengths in nm</span>
<span class="sd">            &#39;dXnm&#39;: Flexure x offset in nm</span>
<span class="sd">            &#39;dYpix&#39;: Flexure y offset in pixels</span>
<span class="sd">            &#39;xfwhm&#39;: Fit FWHM of sky line used to estimate flexure</span>
<span class="sd">            &#39;yfwhm&#39;: Average FWHM of spaxel trace in y direction</span>
<span class="sd">            &#39;exptime&#39;: Total exposure time of observation in seconds</span>
<span class="sd">            &#39;extinction_corr&#39;: Extinction correction for observation</span>
<span class="sd">            &#39;skyph&#39;: Sky flux in photon/10min/nm/spaxel</span>
<span class="sd">            &#39;skynm&#39;: Sky wavelengths in nm</span>
<span class="sd">            &#39;var&#39;: Variance spectrum</span>
<span class="sd">            &#39;radius_as&#39;: Extraction radius in arcsec</span>
<span class="sd">            &#39;position&#39;: Position offset relative to center in arcsec</span>
<span class="sd">            &#39;N_spax&#39;: Number of spaxels summed for target</span>
<span class="sd">            &#39;meta&#39;: Metadata dictionary for extractions</span>
<span class="sd">            &#39;object_spaxel_ids&#39;: Object spaxel IDs for target</span>
<span class="sd">            &#39;sky_spaxel_ids&#39;: Sky spaxel IDS for target</span>
<span class="sd">            &#39;sky_spectra&#39;: Individual sky spaxel spectra</span>
<span class="sd">            &#39;sky_subtraction&#39;: False if no sky subtraction else True</span>
<span class="sd">            &#39;quality&#39;: Estimate of spectral quality (1 = best)</span>
<span class="sd">            &#39;dlam&#39;: Wavelength offsets between samples in nm</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Load wavelength/spatial solution</span>
    <span class="n">fine</span><span class="p">,</span> <span class="n">fmeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fine</span><span class="p">)</span>
    <span class="c1"># Set a default outname if needed</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">imfile</span>
    <span class="c1"># Check for flexure offsets</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Dx </span><span class="si">%2.1f</span><span class="s2"> nm | Dy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;xfwhm&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;FWHMx </span><span class="si">%2.1f</span><span class="s2"> nm | FWHMy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">],</span>
                                                       <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># The spaxel extraction already exist, so load them in</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;USING extractions in </span><span class="si">%s</span><span class="s2">.npy!&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="k">print</span> <span class="s2">&quot;rm </span><span class="si">%s</span><span class="s2">.npy # if you want to recreate extractions&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
    <span class="c1"># No extractions yet, so generate them</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CREATING extractions ...&quot;</span>
        <span class="c1"># Load spectrum image</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imfile</span><span class="p">)</span>
        <span class="c1"># Set up variance image by adding read noise to Poisson noise</span>
        <span class="n">adcspeed</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ADCSPEED&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">adcspeed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">22</span><span class="o">*</span><span class="mi">22</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">5</span>
        <span class="c1"># Variance image is input image plus read variance</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">addcon</span><span class="p">(</span><span class="n">imfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">read_var</span><span class="p">),</span> <span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        <span class="c1"># Extract each object spaxel</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting object spectra&quot;</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>
        <span class="c1"># Extract metadata</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;HA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_HA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_DEC&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_RA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PRLLTC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_PA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;EQUINOX&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELEQX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;UTC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tjd</span><span class="o">.</span><span class="n">yday</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmeta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="c1"># Save object extraction</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="c1"># Extract each variance spaxel</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting variance spectra&quot;</span>
        <span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>
        <span class="c1"># Save variance extraction</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">e_var</span><span class="p">,</span> <span class="n">meta_var</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote var_</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>

    <span class="k">if</span> <span class="n">specExtract</span><span class="p">:</span>
        <span class="c1"># Get the object name of record</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">autoExtract</span><span class="p">:</span>
            <span class="c1"># Automatic extraction using Gaussian fit for Standard Stars</span>
            <span class="n">sixa</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">adcpos</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> \
                <span class="n">identify_spectra_gauss_fit</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span>
                                           <span class="n">prlltc</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">],</span>
                                                        <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
                                           <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                                           <span class="n">airmass</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span>
                                           <span class="n">sigfac</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">radius_used</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># something went wrong</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># by definition</span>

            <span class="c1"># Stats for automatic fit</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nosky&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;scaled&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                     <span class="s2">&quot;lmin&quot;</span><span class="p">:</span> <span class="n">lmin</span><span class="p">,</span> <span class="s2">&quot;lmax&quot;</span><span class="p">:</span> <span class="n">lmax</span><span class="p">,</span>
                     <span class="s2">&quot;cmin&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;cmax&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

            <span class="c1"># Use all sky spaxels in image</span>
            <span class="n">kixa</span> <span class="o">=</span> <span class="n">identify_sky_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mark positive (red) target&quot;</span>

            <span class="c1"># A single-frame Science Object</span>
            <span class="n">sixa</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">adcpos</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> \
                <span class="n">identify_spectra_gui</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                     <span class="n">prlltc</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
                                     <span class="n">scaled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bgd_sub</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                     <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                                     <span class="n">objname</span><span class="o">=</span><span class="n">objname</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span>
                                     <span class="n">nosky</span><span class="o">=</span><span class="n">nosky</span><span class="p">,</span>
                                     <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="n">radius_used</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">interact</span><span class="p">:</span>

                <span class="c1"># Get quality of observation</span>
                <span class="k">print</span> <span class="s2">&quot;Enter quality of observation:&quot;</span>
                <span class="k">print</span> <span class="s2">&quot;1 - good       (no problems)&quot;</span>
                <span class="k">print</span> <span class="s2">&quot;2 - acceptable (minor problem)&quot;</span>
                <span class="k">print</span> <span class="s2">&quot;3 - poor       (major problem)&quot;</span>
                <span class="k">print</span> <span class="s2">&quot;4 - no object visible&quot;</span>
                <span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prom</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">quality</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;Try again: &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;Try again: &quot;</span>
                <span class="k">print</span> <span class="s2">&quot;Quality = </span><span class="si">%d</span><span class="s2">, now making outputs...&quot;</span> <span class="o">%</span> <span class="n">quality</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">print</span> <span class="s2">&quot;Now making outputs...&quot;</span>

            <span class="c1"># Use an annulus for sky spaxels for Science Objects</span>
            <span class="n">kixa</span> <span class="o">=</span> <span class="n">identify_bgd_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">,</span> <span class="n">expfac</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">sixa</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_sky</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># Make an image of the spaxels for the record</span>
        <span class="n">to_image</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">adcpos</span><span class="o">=</span><span class="n">adcpos</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">,</span>
                 <span class="n">bgd_sub</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                 <span class="n">cmin</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cmin&#39;</span><span class="p">],</span> <span class="n">cmax</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cmax&#39;</span><span class="p">])</span>
        <span class="c1"># get the mean spectrum over the selected spaxels</span>
        <span class="n">resa</span><span class="p">,</span> <span class="n">nsxa</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">sixa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
                                    <span class="n">percent</span><span class="o">=</span><span class="mf">30.</span><span class="p">)</span>
        <span class="n">skya</span><span class="p">,</span> <span class="n">nsxak</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">kixa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_sky.pdf&quot;</span><span class="p">,</span>
                                     <span class="n">sky</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">vara</span><span class="p">,</span> <span class="n">nsxav</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">e_var</span><span class="p">,</span> <span class="n">nsxa</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_var.pdf&quot;</span><span class="p">)</span>
        <span class="c1"># Plot out the X/Y positions of the selected spaxels</span>
        <span class="n">xsa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ysa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xsk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ysk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">nsxa</span><span class="p">:</span>
            <span class="n">xsa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
            <span class="n">ysa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="n">xsk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
                <span class="n">ysk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">posa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ellipse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA offset [asec] @ </span><span class="si">%6.1f</span><span class="s2"> nm&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec offset [asec]&quot;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsa</span><span class="p">,</span> <span class="n">ysa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsk</span><span class="p">,</span> <span class="n">ysk</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tlab</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> selected spaxels for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xsa</span><span class="p">),</span> <span class="n">objname</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;airmass&#39;</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Airmass: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">quality</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;, Qual: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">quality</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tlab</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># / End Plot</span>

        <span class="c1"># Define our standard wavelength grid</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">Wavelength</span><span class="o">.</span><span class="n">fiducial_spectrum</span><span class="p">()</span>
        <span class="c1"># Resample sky onto standard wavelength grid</span>
        <span class="n">sky_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sky</span> <span class="o">=</span> <span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
        <span class="c1"># Resample variance onto standard wavelength grid</span>
        <span class="n">var_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">varspec</span> <span class="o">=</span> <span class="n">var_a</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
        <span class="c1"># Copy and resample object spectrum onto standard wavelength grid</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;doc&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;spectra&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spectra&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;coefficients&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">])}]</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># Calculate airmass correction</span>
        <span class="n">airmass</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">extcorr</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Atm</span><span class="o">.</span><span class="n">ext</span><span class="p">(</span><span class="n">ll</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">airmass</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Median airmass corr: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">extcorr</span><span class="p">)</span>
        <span class="c1"># Calculate output corrected spectrum</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;nosky&#39;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s2">&quot;Sky subtraction off&quot;</span>
            <span class="c1"># Account for airmass and aperture</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">*</span> <span class="n">extcorr</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Sky subtraction on&quot;</span>
            <span class="c1"># Account for sky, airmass and aperture</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f1</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">-</span><span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span> <span class="o">*</span> <span class="n">extcorr</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxa</span><span class="p">)</span>

        <span class="c1"># Store flexure data</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_x_corr_nm</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_y_corr_pix</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfwhm</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfwhm</span>

        <span class="c1"># Store new metadata</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Extinction Correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Applied using Hayes &amp; Latham&#39;</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;extinction_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extcorr</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;skyph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxa</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;skynm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varspec</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius_as&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_used</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;N_spax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxa</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;object_spaxel_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsxa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spaxel_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kixa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;spectra&#39;</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_subtraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;nosky&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">True</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality</span>
        <span class="c1"># Calculate wavelength offsets</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)),</span> <span class="n">ll</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>
        <span class="c1"># Store offsets</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dlam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">newll</span><span class="p">)</span>
        <span class="c1"># Save the final spectrum</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;sp_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote sp_&quot;</span><span class="o">+</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span></div>


<div class="viewcode-block" id="handle_dual"><a class="viewcode-back" href="../../SEDMr.html#SEDMr.Extractor.handle_dual">[docs]</a><span class="k">def</span> <span class="nf">handle_dual</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span>
                <span class="n">flat_corrections</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mf">650.</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="mf">700.</span><span class="p">,</span>
                <span class="n">specExtract</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interact</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads IFU frame &quot;afile&quot; and &quot;bfile&quot; and extract A-B spectra using &quot;fine&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        afile (string): filename of ifu FITS file to extract from.</span>
<span class="sd">        bfile (string): filename of ifu FITS file to extract from.</span>
<span class="sd">        fine (string): filename of NumPy file with locations + wavelength soln.</span>
<span class="sd">        outname (string): filename to write results to</span>
<span class="sd">        offset (2tuple): X (nm)/Y (pix) shift to apply for flexure correction</span>
<span class="sd">        radius (float): Extraction radius in arcseconds</span>
<span class="sd">        flat_corrections (list): A list of FlatCorrection objects for</span>
<span class="sd">            correcting the extraction</span>
<span class="sd">        nosky (Boolean): if True don&#39;t subtract sky, merely sum in aperture</span>
<span class="sd">        lmin (float): lower wavelength limit for image generation</span>
<span class="sd">        lmax (float): upper wavelength limit for image generation</span>
<span class="sd">        specExtract (Boolean): perform extraction to a spectrum?</span>
<span class="sd">        interact (Boolean): Interactively set the quality of the extraction?</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>

<span class="sd">    Note:</span>
<span class="sd">        The extracted spectrum dictionary is written to ``outname``.npy::</span>

<span class="sd">            &#39;doc&#39;: docstring description</span>
<span class="sd">            &#39;ph_10m_nm&#39;: Flux in photon/10min/nm integrated</span>
<span class="sd">            &#39;nm&#39;: Wavelengths in nm</span>
<span class="sd">            &#39;dXnm&#39;: Flexure x offset in nm</span>
<span class="sd">            &#39;dYpix&#39;: Flexure y offset in pixels</span>
<span class="sd">            &#39;xfwhm&#39;: Fit FWHM of sky line used to estimate flexure</span>
<span class="sd">            &#39;yfwhm&#39;: Average FWHM of spaxel trace in y direction</span>
<span class="sd">            &#39;exptime&#39;: Total exposure time of observation in seconds</span>
<span class="sd">            &#39;extinction_corr_A&#39;: Extinction correction for A observation</span>
<span class="sd">            &#39;extinction_corr_B&#39;: Extinction correction for B observation</span>
<span class="sd">            &#39;skyph&#39;: Sky spectrum</span>
<span class="sd">            &#39;var&#39;: Variance spectrum</span>
<span class="sd">            &#39;radius_as&#39;: Extraction radius in arcseconds</span>
<span class="sd">            &#39;positionA&#39;: Position offset relative to center of A in arcsec</span>
<span class="sd">            &#39;positionB&#39;: Position offset relative to center of B in arcsec</span>
<span class="sd">            &#39;N_spaxA&#39;: Total number of &quot;A&quot; spaxels</span>
<span class="sd">            &#39;N_spaxB&#39;: Total number of &quot;B&quot; spaxels</span>
<span class="sd">            &#39;meta&#39;: Metadata dictionary for extractions</span>
<span class="sd">            &#39;object_spaxel_ids_A&#39;: Object spaxel IDs for A target</span>
<span class="sd">            &#39;sky_spaxel_ids_A&#39;: Sky spaxel IDs for A target</span>
<span class="sd">            &#39;object_spaxel_ids_B&#39;: Object spaxel IDs for B target</span>
<span class="sd">            &#39;sky_spaxel_ids_B&#39;: Sky spaxel IDS for B target</span>
<span class="sd">            &#39;sky_subtraction&#39;: False if no sky subtraction else True</span>
<span class="sd">            &#39;quality&#39;: Estimate of spectral quality (1 = best)</span>
<span class="sd">            &#39;dlam&#39;: Wavelength offsets between samples in nm</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fine</span><span class="p">,</span> <span class="n">fmeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fine</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">m</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="o">-</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Dx </span><span class="si">%2.1f</span><span class="s2"> nm | Dy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">],</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;xfwhm&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;FWHMx </span><span class="si">%2.1f</span><span class="s2"> nm | FWHMy </span><span class="si">%2.1f</span><span class="s2"> px&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">],</span>
                                                       <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flexure_x_corr_nm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flexure_y_corr_pix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xfwhm</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">yfwhm</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;USING extractions in </span><span class="si">%s</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="k">print</span> <span class="s2">&quot;rm </span><span class="si">%s</span><span class="s2">.npy # if you want to recreate extractions&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="n">ex_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CREATING extractions ...&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">subtract</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">,</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">,</span> <span class="s2">&quot;tmpvar_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>

        <span class="n">adcspeed</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ADCSPEED&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">adcspeed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">22</span><span class="o">*</span><span class="mi">22</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">read_var</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">5</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">addcon</span><span class="p">(</span><span class="s2">&quot;tmpvar_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">read_var</span><span class="p">),</span>
                     <span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmpvar_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s2">&quot;.fits.gz&quot;</span><span class="p">)</span>

        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting object spectra&quot;</span>
        <span class="n">ex</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass1&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass2&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;HA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_HA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;DEC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_DEC&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;RA&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_RA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PRLLTC&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TEL_PA&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;EQUINOX&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">else</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELEQX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;UTC&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;JD&#39;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;jd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tjd</span><span class="o">.</span><span class="n">yday</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmeta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">]</span>

        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>

        <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting variance spectra&quot;</span>
        <span class="n">ex_var</span><span class="p">,</span> <span class="n">meta_var</span> <span class="o">=</span> \
            <span class="n">Wavelength</span><span class="o">.</span><span class="n">wavelength_extract</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span>
                                          <span class="n">flexure_x_corr_nm</span><span class="o">=</span><span class="n">flexure_x_corr_nm</span><span class="p">,</span>
                                          <span class="n">flexure_y_corr_pix</span><span class="o">=</span><span class="n">flexure_y_corr_pix</span><span class="p">,</span>
                                          <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat_corrections</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="p">[</span><span class="n">ex_var</span><span class="p">,</span> <span class="n">meta_var</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote var_</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">outname</span>

    <span class="k">if</span> <span class="n">specExtract</span><span class="p">:</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mark positive (red) target first&quot;</span>

        <span class="n">sixa</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">adc_a</span><span class="p">,</span> <span class="n">ellipse</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> \
            <span class="n">identify_spectra_gui</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">prlltc</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
                                 <span class="n">scaled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                 <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                                 <span class="n">objname</span><span class="o">=</span><span class="n">objname</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span>
                                 <span class="n">nosky</span><span class="o">=</span><span class="n">nosky</span><span class="p">,</span>
                                 <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="n">radius_used_a</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">sixa</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mark negative (blue) target next&quot;</span>

        <span class="n">sixb</span><span class="p">,</span> <span class="n">posb</span><span class="p">,</span> <span class="n">adc_b</span><span class="p">,</span> <span class="n">ellipseb</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> \
            <span class="n">identify_spectra_gui</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius_used_a</span><span class="p">,</span>
                                 <span class="n">prlltc</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PRLLTC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
                                 <span class="n">scaled</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;scaled&quot;</span><span class="p">],</span>
                                 <span class="n">lmin</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;lmin&quot;</span><span class="p">],</span> <span class="n">lmax</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;lmax&quot;</span><span class="p">],</span>
                                 <span class="n">cmin</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cmin&quot;</span><span class="p">],</span> <span class="n">cmax</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cmax&quot;</span><span class="p">],</span>
                                 <span class="n">objname</span><span class="o">=</span><span class="n">objname</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass&#39;</span><span class="p">],</span>
                                 <span class="n">nosky</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;nosky&quot;</span><span class="p">],</span>
                                 <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">sixb</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">interact</span><span class="p">:</span>

            <span class="c1"># Get quality of observation</span>
            <span class="k">print</span> <span class="s2">&quot;Enter quality of observation:&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;1 - good       (no problems)&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;2 - acceptable (minor problem)&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;3 - poor       (major problem)&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;4 - no object visible&quot;</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prom</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">quality</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">quality</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;Try again: &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prom</span> <span class="o">=</span> <span class="s2">&quot;Try again: &quot;</span>
            <span class="k">print</span> <span class="s2">&quot;Quality = </span><span class="si">%d</span><span class="s2">, now making outputs...&quot;</span> <span class="o">%</span> <span class="n">quality</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span> <span class="s2">&quot;Now making outputs...&quot;</span>

        <span class="n">to_image</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">posb</span><span class="o">=</span><span class="n">posb</span><span class="p">,</span> <span class="n">adcpos</span><span class="o">=</span><span class="n">adc_a</span><span class="p">,</span>
                 <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">,</span> <span class="n">ellipseb</span><span class="o">=</span><span class="n">ellipseb</span><span class="p">,</span>
                 <span class="n">lmin</span><span class="o">=</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="n">lmax</span><span class="p">,</span>
                 <span class="n">cmin</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cmin&quot;</span><span class="p">],</span>
                 <span class="n">cmax</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cmax&quot;</span><span class="p">])</span>

        <span class="n">kixa</span> <span class="o">=</span> <span class="n">identify_bgd_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">posa</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipse</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_sky</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="n">kixa</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        <span class="n">kixb</span> <span class="o">=</span> <span class="n">identify_bgd_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">posb</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="n">ellipseb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixb</span><span class="p">:</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_sky</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="n">kixb</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>

        <span class="n">resa</span><span class="p">,</span> <span class="n">nsxA</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">sixa</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_A.pdf&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">30.</span><span class="p">)</span>
        <span class="n">resb</span><span class="p">,</span> <span class="n">nsxB</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">sixb</span><span class="p">,</span> <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_B.pdf&quot;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">30.</span><span class="p">)</span>
        <span class="n">skya</span><span class="p">,</span> <span class="n">nsxAk</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">kixa</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_skyA.pdf&quot;</span><span class="p">,</span> <span class="n">sky</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">skyb</span><span class="p">,</span> <span class="n">nsxBk</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">kixb</span><span class="p">,</span> <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_skyB.pdf&quot;</span><span class="p">,</span> <span class="n">sky</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">vara</span><span class="p">,</span> <span class="n">nsxAv</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex_var</span><span class="p">,</span> <span class="n">nsxA</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_A_var.pdf&quot;</span><span class="p">)</span>
        <span class="n">varb</span><span class="p">,</span> <span class="n">nsxBv</span> <span class="o">=</span> <span class="n">interp_spectra</span><span class="p">(</span><span class="n">ex_var</span><span class="p">,</span> <span class="n">nsxB</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">outname</span><span class="o">=</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;_B_var.pdf&quot;</span><span class="p">)</span>

        <span class="c1"># Plot out the X/Y selected spectra</span>
        <span class="n">xsa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ysa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xsb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ysb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xka</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">yka</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xkb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ykb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">nsxA</span><span class="p">:</span>
            <span class="n">xsa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
            <span class="n">ysa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">nsxB</span><span class="p">:</span>
            <span class="n">xsb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
            <span class="n">ysb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixa</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="n">xka</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
                <span class="n">yka</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">kixb</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">is_obj</span><span class="p">:</span>
                <span class="n">xkb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">X_as</span><span class="p">)</span>
                <span class="n">ykb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">Y_as</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">posa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">posb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">posb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">posb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ellipse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ellipseb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">get_ellipse_xys</span><span class="p">(</span><span class="n">ellipseb</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xys</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.-&#39;</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA offset [asec] @ </span><span class="si">%6.1f</span><span class="s2"> nm&quot;</span> <span class="o">%</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;fiducial_wavelength&#39;</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec offset [asec]&quot;</span><span class="p">)</span>
        <span class="n">tlab</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> selected spaxels for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">)),</span>
                                               <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;outname&#39;</span><span class="p">])</span>
        <span class="n">air</span> <span class="o">=</span> <span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass2&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;, Airmass: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">air</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">quality</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tlab</span> <span class="o">+=</span> <span class="s2">&quot;, Qual: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">quality</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tlab</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsa</span><span class="p">,</span> <span class="n">ysa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xsb</span><span class="p">,</span> <span class="n">ysb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xka</span><span class="p">,</span> <span class="n">yka</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xkb</span><span class="p">,</span> <span class="n">ykb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote XYs_</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">outname</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># / End Plot</span>

        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;sp_A_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">resa</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;sp_B_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">resb</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;var_A_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">vara</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;var_B_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">varb</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Wrote sp_A_</span><span class="si">%s</span><span class="s2">.npy, sp_B_</span><span class="si">%s</span><span class="s2">.npy, var_A_</span><span class="si">%s</span><span class="s2">.npy, var_B_</span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">outname</span><span class="p">))</span>

        <span class="n">ll</span> <span class="o">=</span> <span class="n">Wavelength</span><span class="o">.</span><span class="n">fiducial_spectrum</span><span class="p">()</span>
        <span class="n">sky_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">skya</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sky_b</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">skyb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">skyb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">([</span><span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="n">sky_b</span><span class="p">(</span><span class="n">ll</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">var_a</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">vara</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">var_b</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">varb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">varb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span>
                         <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">varspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">([</span><span class="n">var_a</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="n">var_b</span><span class="p">(</span><span class="n">ll</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;doc&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ph_10m_nm&quot;</span><span class="p">])}]</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">resa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">resb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nm&#39;</span><span class="p">],</span> <span class="n">resb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">airmassa</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass1&#39;</span><span class="p">]</span>
        <span class="n">airmassb</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;airmass2&#39;</span><span class="p">]</span>

        <span class="n">extcorra</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Atm</span><span class="o">.</span><span class="n">ext</span><span class="p">(</span><span class="n">ll</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">airmassa</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">extcorrb</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Atm</span><span class="o">.</span><span class="n">ext</span><span class="p">(</span><span class="n">ll</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">airmassb</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Median airmass corrs A: </span><span class="si">%.4f</span><span class="s2">, B: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">extcorra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">extcorrb</span><span class="p">)))</span>
        <span class="c1"># If requested merely sum in aperture, otherwise subtract sky</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;nosky&#39;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s2">&quot;Sky subtraction off&quot;</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">f1</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">*</span> <span class="n">extcorra</span><span class="p">,</span> <span class="n">f2</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">*</span> <span class="n">extcorrb</span><span class="p">],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Sky subtraction on&quot;</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ph_10m_nm&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([(</span><span class="n">f1</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">-</span><span class="n">sky_a</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span> <span class="o">*</span> <span class="n">extcorra</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">-</span><span class="n">sky_b</span><span class="p">(</span><span class="n">ll</span><span class="p">))</span> <span class="o">*</span> <span class="n">extcorrb</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> \
                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">))</span>

        <span class="c1"># Store flexure data</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dXnm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_x_corr_nm</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dYpix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flexure_y_corr_pix</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;xfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfwhm</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;yfwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfwhm</span>

        <span class="c1"># Store new metatdata</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Extinction Correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Applied using Hayes &amp; Latham&#39;</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;extinction_corr_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extcorra</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;extinction_corr_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extcorrb</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;skyph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">))</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varspec</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius_as&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_used_a</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;positionA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;positionB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;N_spaxA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxA</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;N_spaxB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsxB</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;object_spaxel_ids_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsxA</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spaxel_ids_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kixa</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;object_spaxel_ids_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsxB</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_spaxel_ids_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kixb</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sky_subtraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;nosky&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">True</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality</span>
        <span class="c1"># Calculate wavelength offsets</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)),</span> <span class="n">ll</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newll</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>
        <span class="c1"># Store offsets</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dlam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">newll</span><span class="p">)</span>
        <span class="c1"># Save the final spectrum</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;sp_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Wrote sp_&quot;</span><span class="o">+</span><span class="n">outname</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;Extract a spectrum from an image using a geometric cube solution.</span>
<span class="sd">Handles a single A image and A+B pair as well as flat extraction.</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--A&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;FITS A file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--B&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;FITS B file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fine&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Numpy fine wavelength solution&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outname&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Prefix output name&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--std&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of standard&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Aoffset&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of &quot;A&quot; flexure offset correction file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--radius_as&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Extraction radius in arcseconds&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--flat_correction&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of flat field .npy file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nosky&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No sky subtraction: only sum in aperture&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--extflat&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Perform flat extraction&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--specExtract&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Perform spectral extraction&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--autoExtract&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Perform automatic extraction&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--interact&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Interactively set the quality&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">print</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">outname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">flat_correction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Using flat data in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">flat_correction</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">flat_correction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;A B Extraction to </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>
        <span class="n">handle_dual</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">,</span>
                    <span class="n">offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">Aoffset</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">radius_as</span><span class="p">,</span>
                    <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nosky</span><span class="p">,</span>
                    <span class="n">specExtract</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">specExtract</span><span class="p">,</span>
                    <span class="n">interact</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">interact</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">extflat</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Flat Extraction to </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>
                <span class="n">handle_flat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Single Extraction to </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>
                <span class="n">handle_single</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">,</span>
                              <span class="n">offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">Aoffset</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">radius_as</span><span class="p">,</span>
                              <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span> <span class="n">nosky</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nosky</span><span class="p">,</span>
                              <span class="n">specExtract</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">specExtract</span><span class="p">,</span>
                              <span class="n">autoExtract</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">autoExtract</span><span class="p">,</span>
                              <span class="n">interact</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">interact</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Standard Star Extraction to </span><span class="si">%s</span><span class="s2">.npy&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">outname</span>
            <span class="n">star</span> <span class="o">=</span> <span class="n">Stds</span><span class="o">.</span><span class="n">Standards</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">std</span><span class="p">]</span>
            <span class="n">handle_std</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outname</span><span class="p">,</span>
                       <span class="n">standard</span><span class="o">=</span><span class="n">star</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">Aoffset</span><span class="p">,</span>
                       <span class="n">flat_corrections</span><span class="o">=</span><span class="n">flat</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;I do not understand your intent, you must specify --A, at least&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Nick Konidaris, Don Neill, Nadia Blagorodnova.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>